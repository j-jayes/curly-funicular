
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="FastAPI framework, high performance, easy to learn, fast to code, ready for production">
      
      
      
        <link rel="canonical" href="https://fastapi.tiangolo.com/advanced/security/oauth2-scopes/">
      
      
        <link rel="prev" href="../">
      
      
        <link rel="next" href="../http-basic-auth/">
      
      
        
          <link rel="alternate" href="/" hreflang="en">
        
          <link rel="alternate" href="/de/" hreflang="en">
        
          <link rel="alternate" href="/es/" hreflang="en">
        
          <link rel="alternate" href="/ko/" hreflang="en">
        
          <link rel="alternate" href="/pt/" hreflang="en">
        
          <link rel="alternate" href="/ru/" hreflang="en">
        
          <link rel="alternate" href="/uk/" hreflang="en">
        
      
      
      <link rel="icon" href="../../../img/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>OAuth2 scopes - FastAPI</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../css/termynal.css">
    
      <link rel="stylesheet" href="../../../css/custom.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  
<meta property="og:type" content="website" />
<meta property="og:title" content="OAuth2 scopes - FastAPI" />
<meta property="og:description" content="FastAPI framework, high performance, easy to learn, fast to code, ready for production" />
<meta property="og:image" content="https://fastapi.tiangolo.com/assets/images/social/advanced/security/oauth2-scopes.png" />
<meta property="og:image:type" content="image/png" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:url" content="https://fastapi.tiangolo.com/advanced/security/oauth2-scopes/" />
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:title" content="OAuth2 scopes - FastAPI" />
<meta property="twitter:description" content="FastAPI framework, high performance, easy to learn, fast to code, ready for production" />
<meta property="twitter:image" content="https://fastapi.tiangolo.com/assets/images/social/advanced/security/oauth2-scopes.png" />
</head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#oauth2-scopes" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
            
<div class="announce-wrapper">
  <div id="announce-left">
    <div class="item">
      <a class="announce-link" href="https://fastapicloud.com" target="_blank">
        <span class="twemoji">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 19c0 .34.04.67.09 1H6.5c-1.5 0-2.81-.5-3.89-1.57C1.54 17.38 1 16.09 1 14.58q0-1.95 1.17-3.48C3.34 9.57 4 9.43 5.25 9.15c.42-1.53 1.25-2.77 2.5-3.72S10.42 4 12 4c1.95 0 3.6.68 4.96 2.04S19 9.05 19 11c1.15.13 2.1.63 2.86 1.5.51.57.84 1.21 1 1.92A5.9 5.9 0 0 0 19 13c-3.31 0-6 2.69-6 6m3-1h2v4h2v-4h2l-3-3z"/></svg>
        </span> Join the <strong>FastAPI Cloud</strong> waiting list üöÄ
      </a>
    </div>
    <div class="item">
      <a class="announce-link" href="https://x.com/fastapi" target="_blank">
        <span class="twemoji">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M357.2 48h70.6L273.6 224.2 455 464H313L201.7 318.6 74.5 464H3.8l164.9-188.5L-5.2 48h145.6l100.5 132.9zm-24.8 373.8h39.1L119.1 88h-42z"/></svg>
        </span> Follow <strong>@fastapi</strong> on <strong>X (Twitter)</strong> to stay updated
      </a>
    </div>
    <div class="item">
      <a class="announce-link" href="https://www.linkedin.com/company/fastapi" target="_blank">
        <span class="twemoji linkedin">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
        </span> Follow <strong>FastAPI</strong> on <strong>LinkedIn</strong> to stay updated
      </a>
    </div>
    <div class="item">
      <a class="announce-link" href="https://fastapi.tiangolo.com/newsletter/">
        <span class="twemoji">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m20 8-8 5-8-5V6l8 5 8-5m0-2H4c-1.11 0-2 .89-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2"/></svg>
        </span> Subscribe to the <strong>FastAPI and friends</strong> newsletter üéâ
      </a>
    </div>
  </div>
  <div id="announce-right" style="position: relative;">
    <div class="item">
      <a title="BlockBee Cryptocurrency Payment Gateway" style="display: block; position: relative;" href="https://blockbee.io?ref=fastapi" target="_blank">
        <span class="sponsor-badge">sponsor</span>
        <img class="sponsor-image" src="/img/sponsors/blockbee-banner.png" />
      </a>
    </div>
    <div class="item">
      <a title="Scalar: Beautiful Open-Source API References from Swagger/OpenAPI files" style="display: block; position: relative;" href="https://github.com/scalar/scalar/?utm_source=fastapi&utm_medium=website&utm_campaign=top-banner" target="_blank">
        <span class="sponsor-badge">sponsor</span>
        <img class="sponsor-image" src="/img/sponsors/scalar-banner.svg" />
      </a>
    </div>
    <div class="item">
      <a title="Auth, user management and more for your B2B product" style="display: block; position: relative;" href="https://www.propelauth.com/?utm_source=fastapi&utm_campaign=1223&utm_medium=topbanner" target="_blank">
        <span class="sponsor-badge">sponsor</span>
        <img class="sponsor-image" src="/img/sponsors/propelauth-banner.png" />
      </a>
    </div>
    <div class="item">
      <a title="Zuplo: Scale, Protect, Document, and Monetize your FastAPI" style="display: block; position: relative;" href="https://zuplo.link/fastapi-web" target="_blank">
        <span class="sponsor-badge">sponsor</span>
        <img class="sponsor-image" src="/img/sponsors/zuplo-banner.png" />
      </a>
    </div>
    <div class="item">
      <a title="liblab - Generate SDKs from FastAPI" style="display: block; position: relative;" href="https://liblab.com?utm_source=fastapi" target="_blank">
        <span class="sponsor-badge">sponsor</span>
        <img class="sponsor-image" src="/img/sponsors/liblab-banner.png" />
      </a>
    </div>
    <div class="item">
      <a title="Deploy & scale any full-stack web app on Render. Focus on building apps, not infra." style="display: block; position: relative;" href="https://docs.render.com/deploy-fastapi?utm_source=deploydoc&utm_medium=referral&utm_campaign=fastapi" target="_blank">
        <span class="sponsor-badge">sponsor</span>
        <img class="sponsor-image" src="/img/sponsors/render-banner.svg" />
      </a>
    </div>
    <div class="item">
      <a title="Cut Code Review Time & Bugs in Half with CodeRabbit" style="display: block; position: relative;" href="https://www.coderabbit.ai/?utm_source=fastapi&utm_medium=banner&utm_campaign=fastapi" target="_blank">
        <span class="sponsor-badge">sponsor</span>
        <img class="sponsor-image" src="/img/sponsors/coderabbit-banner.png" />
      </a>
    </div>
    <div class="item">
      <a title="Making Retail Purchases Actionable for Brands and Developers" style="display: block; position: relative;" href="https://subtotal.com/?utm_source=fastapi&utm_medium=sponsorship&utm_campaign=open-source" target="_blank">
        <span class="sponsor-badge">sponsor</span>
        <img class="sponsor-image" src="/img/sponsors/subtotal-banner.svg" />
      </a>
    </div>
    <div class="item">
      <a title="Deploy enterprise applications at startup speed" style="display: block; position: relative;" href="https://docs.railway.com/guides/fastapi?utm_medium=integration&utm_source=docs&utm_campaign=fastapi" target="_blank">
        <span class="sponsor-badge">sponsor</span>
        <img class="sponsor-image" src="/img/sponsors/railway-banner.png" />
      </a>
    </div>
    <div class="item">
      <a title="SerpApi: Web Search API" style="display: block; position: relative;" href="https://serpapi.com/?utm_source=fastapi_website" target="_blank">
        <span class="sponsor-badge">sponsor</span>
        <img class="sponsor-image" src="/img/sponsors/serpapi-banner.png" />
      </a>
    </div>
    <div class="item">
      <a title="Greptile: The AI Code Reviewer" style="display: block; position: relative;" href="https://www.greptile.com/?utm_source=fastapi&utm_medium=sponsorship&utm_campaign=fastapi_sponsor_page" target="_blank">
        <span class="sponsor-badge">sponsor</span>
        <img class="sponsor-image" src="/img/sponsors/greptile-banner.png" />
      </a>
    </div>
  </div>
</div>

          </div>
          
        </aside>
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="FastAPI" class="md-header__button md-logo" aria-label="FastAPI" data-md-component="logo">
      
  <img src="../../../img/icon-white.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            FastAPI
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              OAuth2 scopes
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 2C5.13 2 2 5.13 2 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.87-3.13-7-7-7M6 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H6zm13-8h-2l-3.2 9h1.9l.7-2h3.2l.7 2h1.9zm-2.15 5.65L18 15l1.15 3.65z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="amber"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="amber"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="Select language">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="/" hreflang="" class="md-select__link">
              en - English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="/de/" hreflang="" class="md-select__link">
              de - Deutsch
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="/es/" hreflang="" class="md-select__link">
              es - espa√±ol
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="/ko/" hreflang="" class="md-select__link">
              ko - ÌïúÍµ≠Ïñ¥
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="/pt/" hreflang="" class="md-select__link">
              pt - portugu√™s
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="/ru/" hreflang="" class="md-select__link">
              ru - —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="/uk/" hreflang="" class="md-select__link">
              uk - —É–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –º–æ–≤–∞
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/fastapi/fastapi" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M202.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M496 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
  </div>
  <div class="md-source__repository">
    fastapi/fastapi
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  FastAPI

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../features/" class="md-tabs__link">
        
  
  
    
  
  Features

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../learn/" class="md-tabs__link">
          
  
  
    
  
  Learn 

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../reference/" class="md-tabs__link">
          
  
  
    
  
  Reference

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../fastapi-people/" class="md-tabs__link">
        
  
  
    
  
  FastAPI People

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../resources/" class="md-tabs__link">
          
  
  
    
  
  Resources 

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../about/" class="md-tabs__link">
          
  
  
    
  
  About 

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../release-notes/" class="md-tabs__link">
        
  
  
    
  
  Release Notes

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="FastAPI" class="md-nav__button md-logo" aria-label="FastAPI" data-md-component="logo">
      
  <img src="../../../img/icon-white.svg" alt="logo">

    </a>
    FastAPI
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/fastapi/fastapi" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M202.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M496 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
  </div>
  <div class="md-source__repository">
    fastapi/fastapi
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FastAPI
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Features
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../learn/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Learn 
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Learn 
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../python-types/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Python Types Intro
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../async/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Concurrency and async / await
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../environment-variables/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Environment Variables
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../virtual-environments/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Virtual Environments
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../tutorial/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Tutorial - User Guide 
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tutorial - User Guide 
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/first-steps/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      First Steps
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/path-params/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Path Parameters
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/query-params/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Query Parameters
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/body/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Request Body
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/query-params-str-validations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Query Parameters and String Validations
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/path-params-numeric-validations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Path Parameters and Numeric Validations
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/query-param-models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Query Parameter Models
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/body-multiple-params/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Body - Multiple Parameters
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/body-fields/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Body - Fields
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/body-nested-models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Body - Nested Models
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/schema-extra-example/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Declare Request Example Data
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/extra-data-types/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Extra Data Types
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/cookie-params/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Cookie Parameters
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/header-params/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Header Parameters
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/cookie-param-models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Cookie Parameter Models
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/header-param-models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Header Parameter Models
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/response-model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Response Model - Return Type
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/extra-models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Extra Models
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/response-status-code/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Response Status Code
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/request-forms/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Form Data
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/request-form-models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Form Models
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/request-files/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Request Files
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/request-forms-and-files/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Request Forms and Files
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/handling-errors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Handling Errors
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/path-operation-configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Path Operation Configuration
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/encoder/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      JSON Compatible Encoder
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/body-updates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Body - Updates
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_6_29" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../tutorial/dependencies/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Dependencies 
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_6_29" id="__nav_3_6_29_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_6_29_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_6_29">
            <span class="md-nav__icon md-icon"></span>
            
  
    Dependencies 
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/dependencies/classes-as-dependencies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Classes as Dependencies
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/dependencies/sub-dependencies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Sub-dependencies
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/dependencies/dependencies-in-path-operation-decorators/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Dependencies in path operation decorators
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/dependencies/global-dependencies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Global Dependencies
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/dependencies/dependencies-with-yield/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Dependencies with yield
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_6_30" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../tutorial/security/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Security 
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_6_30" id="__nav_3_6_30_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_6_30_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_6_30">
            <span class="md-nav__icon md-icon"></span>
            
  
    Security 
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/security/first-steps/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Security - First Steps
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/security/get-current-user/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Get Current User
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/security/simple-oauth2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Simple OAuth2 with Password and Bearer
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/security/oauth2-jwt/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      OAuth2 with Password (and hashing), Bearer with JWT tokens
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/middleware/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Middleware
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/cors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      CORS (Cross-Origin Resource Sharing)
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/sql-databases/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      SQL (Relational) Databases
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/bigger-applications/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Bigger Applications - Multiple Files
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/background-tasks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Background Tasks
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/metadata/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Metadata and Docs URLs
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/static-files/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Static Files
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Testing
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/debugging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Debugging
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_7" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Advanced User Guide 
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_7" id="__nav_3_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Advanced User Guide 
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../path-operation-advanced-configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Path Operation Advanced Configuration
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../additional-status-codes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Additional Status Codes
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../response-directly/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Return a Response Directly
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../custom-response/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Custom Response - HTML, Stream, File, others
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../additional-responses/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Additional Responses in OpenAPI
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../response-cookies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Response Cookies
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../response-headers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Response Headers
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../response-change-status-code/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Response - Change Status Code
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../advanced-dependencies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Advanced Dependencies
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_7_11" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Advanced Security 
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_7_11" id="__nav_3_7_11_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_7_11_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_7_11">
            <span class="md-nav__icon md-icon"></span>
            
  
    Advanced Security 
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      OAuth2 scopes
    </span>
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      OAuth2 scopes
    </span>
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#oauth2-scopes-and-openapi" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          OAuth2 scopes and OpenAPI
        </span>
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#global-view" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          Global view
        </span>
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#oauth2-security-scheme" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          OAuth2 Security scheme
        </span>
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jwt-token-with-scopes" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          JWT token with scopes
        </span>
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#declare-scopes-in-path-operations-and-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          Declare scopes in <em>path operations</em> and dependencies
        </span>
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#use-securityscopes" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          Use <code>SecurityScopes</code>
        </span>
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#use-the-scopes" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          Use the <code>scopes</code>
        </span>
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#verify-the-username-and-data-shape" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          Verify the <code>username</code> and data shape
        </span>
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#verify-the-scopes" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          Verify the <code>scopes</code>
        </span>
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dependency-tree-and-scopes" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          Dependency tree and scopes
        </span>
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#more-details-about-securityscopes" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          More details about <code>SecurityScopes</code>
        </span>
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#check-it" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          Check it
        </span>
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#about-third-party-integrations" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          About third party integrations
        </span>
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security-in-decorator-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          <code>Security</code> in decorator <code>dependencies</code>
        </span>
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../http-basic-auth/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      HTTP Basic Auth
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../using-request-directly/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Using the Request Directly
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dataclasses/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Using Dataclasses
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../middleware/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Advanced Middleware
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sub-applications/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Sub Applications - Mounts
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../behind-a-proxy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Behind a Proxy
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../templates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Templates
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../websockets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      WebSockets
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../events/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Lifespan Events
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../testing-websockets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Testing WebSockets
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../testing-events/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Testing Events: lifespan and startup - shutdown
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../testing-dependencies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Testing Dependencies with Overrides
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../async-tests/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Async Tests
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../settings/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Settings and Environment Variables
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../openapi-callbacks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      OpenAPI Callbacks
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../openapi-webhooks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      OpenAPI Webhooks
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wsgi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Including WSGI - Flask, Django, others
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../generate-clients/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Generating SDKs
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../fastapi-cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      FastAPI CLI
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_9" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../deployment/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Deployment 
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_9" id="__nav_3_9_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Deployment 
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../deployment/versions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      About FastAPI versions
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../deployment/fastapicloud/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      FastAPI Cloud
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../deployment/https/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      About HTTPS
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../deployment/manually/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Run a Server Manually
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../deployment/concepts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Deployments Concepts
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../deployment/cloud/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Deploy FastAPI on Cloud Providers
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../deployment/server-workers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Server Workers - Uvicorn with Workers
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../deployment/docker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      FastAPI in Containers - Docker
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_10" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../how-to/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    How To - Recipes 
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_10" id="__nav_3_10_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    How To - Recipes 
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../how-to/general/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      General - How To - Recipes
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../how-to/migrate-from-pydantic-v1-to-pydantic-v2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Migrate from Pydantic v1 to Pydantic v2
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../how-to/graphql/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      GraphQL
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../how-to/custom-request-and-route/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Custom Request and APIRoute class
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../how-to/conditional-openapi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Conditional OpenAPI
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../how-to/extending-openapi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Extending OpenAPI
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../how-to/separate-openapi-schemas/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Separate OpenAPI Schemas for Input and Output or Not
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../how-to/custom-docs-ui-assets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Custom Docs UI Static Assets (Self-Hosting)
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../how-to/configure-swagger-ui/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Configure Swagger UI
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../how-to/testing-database/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Testing a Database
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../how-to/authentication-error-status-code/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Use Old 403 Authentication Error Status Codes
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../reference/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Reference
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/fastapi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      <code>FastAPI</code> class
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/parameters/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Request Parameters
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/status/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Status Codes
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/uploadfile/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      <code>UploadFile</code> class
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/exceptions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Exceptions - <code>HTTPException</code> and <code>WebSocketException</code>
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/dependencies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Dependencies - <code>Depends()</code> and <code>Security()</code>
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/apirouter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      <code>APIRouter</code> class
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/background/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Background Tasks - <code>BackgroundTasks</code>
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/request/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      <code>Request</code> class
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/websockets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      WebSockets
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/httpconnection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      <code>HTTPConnection</code> class
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/response/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      <code>Response</code> class
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/responses/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Custom Response Classes - File, HTML, Redirect, Streaming, etc.
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/middleware/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Middleware
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_16" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../reference/openapi/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    OpenAPI
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_16" id="__nav_4_16_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_16_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_16">
            <span class="md-nav__icon md-icon"></span>
            
  
    OpenAPI
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/openapi/docs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      OpenAPI <code>docs</code>
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/openapi/models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      OpenAPI <code>models</code>
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/security/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Security Tools
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/encoders/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Encoders - <code>jsonable_encoder</code>
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/staticfiles/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Static Files - <code>StaticFiles</code>
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/templating/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Templating - <code>Jinja2Templates</code>
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/testclient/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Test Client - <code>TestClient</code>
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../fastapi-people/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      FastAPI People
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../resources/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Resources 
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6" id="__nav_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Resources 
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../help-fastapi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Help FastAPI - Get Help
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Development - Contributing
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../project-generation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Full Stack FastAPI Template
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../external-links/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      External Links
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../newsletter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      FastAPI and friends newsletter
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../management-tasks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Repository Management Tasks
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../about/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    About 
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7" id="__nav_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    About 
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../alternatives/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Alternatives, Inspiration and Comparisons
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../history-design-future/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      History, Design and Future
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../benchmarks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Benchmarks
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Repository Management
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../release-notes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    <span class="md-typeset">
      Release Notes
    </span>
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#oauth2-scopes-and-openapi" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          OAuth2 scopes and OpenAPI
        </span>
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#global-view" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          Global view
        </span>
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#oauth2-security-scheme" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          OAuth2 Security scheme
        </span>
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jwt-token-with-scopes" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          JWT token with scopes
        </span>
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#declare-scopes-in-path-operations-and-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          Declare scopes in <em>path operations</em> and dependencies
        </span>
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#use-securityscopes" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          Use <code>SecurityScopes</code>
        </span>
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#use-the-scopes" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          Use the <code>scopes</code>
        </span>
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#verify-the-username-and-data-shape" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          Verify the <code>username</code> and data shape
        </span>
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#verify-the-scopes" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          Verify the <code>scopes</code>
        </span>
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dependency-tree-and-scopes" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          Dependency tree and scopes
        </span>
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#more-details-about-securityscopes" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          More details about <code>SecurityScopes</code>
        </span>
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#check-it" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          Check it
        </span>
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#about-third-party-integrations" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          About third party integrations
        </span>
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security-in-decorator-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          <code>Security</code> in decorator <code>dependencies</code>
        </span>
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
                



  


  <nav class="md-path" aria-label="Navigation" >
    <ol class="md-path__list">
      
        
  
  
    <li class="md-path__item">
      <a href="../../.." class="md-path__link">
        
  <span class="md-ellipsis">
    FastAPI
  </span>

      </a>
    </li>
  

      
      
        
  
  
    
    
      <li class="md-path__item">
        <a href="../../../learn/" class="md-path__link">
          
  <span class="md-ellipsis">
    Learn 
  </span>

        </a>
      </li>
    
  

      
        
  
  
    
    
      <li class="md-path__item">
        <a href="../../" class="md-path__link">
          
  <span class="md-ellipsis">
    Advanced User Guide 
  </span>

        </a>
      </li>
    
  

      
        
  
  
    
    
      <li class="md-path__item">
        <a href="../" class="md-path__link">
          
  <span class="md-ellipsis">
    Advanced Security 
  </span>

        </a>
      </li>
    
  

      
    </ol>
  </nav>

              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="oauth2-scopes">OAuth2 scopes<a class="headerlink" data-preview="" href="#oauth2-scopes" title="Permanent link">&para;</a></h1>
<p>You can use OAuth2 scopes directly with <strong>FastAPI</strong>, they are integrated to work seamlessly.</p>
<p>This would allow you to have a more fine-grained permission system, following the OAuth2 standard, integrated into your OpenAPI application (and the API docs).</p>
<p>OAuth2 with scopes is the mechanism used by many big authentication providers, like Facebook, Google, GitHub, Microsoft, X (Twitter), etc. They use it to provide specific permissions to users and applications.</p>
<p>Every time you "log in with" Facebook, Google, GitHub, Microsoft, X (Twitter), that application is using OAuth2 with scopes.</p>
<p>In this section you will see how to manage authentication and authorization with the same OAuth2 with scopes in your <strong>FastAPI</strong> application.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This is a more or less advanced section. If you are just starting, you can skip it.</p>
<p>You don't necessarily need OAuth2 scopes, and you can handle authentication and authorization however you want.</p>
<p>But OAuth2 with scopes can be nicely integrated into your API (with OpenAPI) and your API docs.</p>
<p>Nevertheless, you still enforce those scopes, or any other security/authorization requirement, however you need, in your code.</p>
<p>In many cases, OAuth2 with scopes can be an overkill.</p>
<p>But if you know you need it, or you are curious, keep reading.</p>
</div>
<h2 id="oauth2-scopes-and-openapi">OAuth2 scopes and OpenAPI<a class="headerlink" data-preview="" href="#oauth2-scopes-and-openapi" title="Permanent link">&para;</a></h2>
<p>The OAuth2 specification defines "scopes" as a list of strings separated by spaces.</p>
<p>The content of each of these strings can have any format, but should not contain spaces.</p>
<p>These scopes represent "permissions".</p>
<p>In OpenAPI (e.g. the API docs), you can define "security schemes".</p>
<p>When one of these security schemes uses OAuth2, you can also declare and use scopes.</p>
<p>Each "scope" is just a string (without spaces).</p>
<p>They are normally used to declare specific security permissions, for example:</p>
<ul>
<li><code>users:read</code> or <code>users:write</code> are common examples.</li>
<li><code>instagram_basic</code> is used by Facebook / Instagram.</li>
<li><code>https://www.googleapis.com/auth/drive</code> is used by Google.</li>
</ul>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>In OAuth2 a "scope" is just a string that declares a specific permission required.</p>
<p>It doesn't matter if it has other characters like <code>:</code> or if it is a URL.</p>
<p>Those details are implementation specific.</p>
<p>For OAuth2 they are just strings.</p>
</div>
<h2 id="global-view">Global view<a class="headerlink" data-preview="" href="#global-view" title="Permanent link">&para;</a></h2>
<p>First, let's quickly see the parts that change from the examples in the main <strong>Tutorial - User Guide</strong> for <a class="internal-link" data-preview="" href="../../../tutorial/security/oauth2-jwt/" target="_blank">OAuth2 with Password (and hashing), Bearer with JWT tokens</a>. Now using OAuth2 scopes:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:1"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Python 3.10+</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span id="__span-0-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-0-2"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>
</span><span id="__span-0-3">
</span><span id="__span-0-4"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-0-5"><span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span></span><span id="__span-0-6"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-0-7">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-0-8">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-0-9"><span class="hll">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span></span><span id="__span-0-10"><span class="p">)</span>
</span><span id="__span-0-11"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-0-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-0-13"><span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span></span><span id="__span-0-14">
</span><span id="__span-0-15"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-0-16"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-0-17"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-0-18"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-0-19"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-0-20">
</span><span id="__span-0-21">
</span><span id="__span-0-22"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-0-23">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-0-24">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-0-25">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-0-26">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-0-27">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-0-28">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-0-29">    <span class="p">},</span>
</span><span id="__span-0-30">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-0-31">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-0-32">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-0-33">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-0-34">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-0-35">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-0-36">    <span class="p">},</span>
</span><span id="__span-0-37"><span class="p">}</span>
</span><span id="__span-0-38">
</span><span id="__span-0-39">
</span><span id="__span-0-40"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-0-41">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-0-42">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-0-43">
</span><span id="__span-0-44">
</span><span id="__span-0-45"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-0-46">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-0-47"><span class="hll">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span id="__span-0-48">
</span><span id="__span-0-49">
</span><span id="__span-0-50"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-0-51">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-0-52">    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-0-53">    <span class="n">full_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-0-54">    <span class="n">disabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-0-55">
</span><span id="__span-0-56">
</span><span id="__span-0-57"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-0-58">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-0-59">
</span><span id="__span-0-60">
</span><span id="__span-0-61"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-0-62">
</span><span id="__span-0-63"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-0-64">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-0-65"><span class="hll">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span></span><span id="__span-0-66"><span class="p">)</span>
</span><span id="__span-0-67">
</span><span id="__span-0-68"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-0-69">
</span><span id="__span-0-70">
</span><span id="__span-0-71"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-0-72">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-0-73">
</span><span id="__span-0-74">
</span><span id="__span-0-75"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-0-76">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-0-77">
</span><span id="__span-0-78">
</span><span id="__span-0-79"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-0-80">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-0-81">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-0-82">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-0-83">
</span><span id="__span-0-84">
</span><span id="__span-0-85"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-0-86">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-0-87">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-0-88">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-0-89">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-0-90">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-0-91">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-0-92">
</span><span id="__span-0-93">
</span><span id="__span-0-94"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">timedelta</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-0-95">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-0-96">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-0-97">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-0-98">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-0-99">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-0-100">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-0-101">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-0-102">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-0-103">
</span><span id="__span-0-104">
</span><span id="__span-0-105"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-0-106"><span class="hll">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)]</span>
</span></span><span id="__span-0-107"><span class="p">):</span>
</span><span id="__span-0-108"><span class="hll">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span></span><span id="__span-0-109"><span class="hll">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span></span><span id="__span-0-110"><span class="hll">    <span class="k">else</span><span class="p">:</span>
</span></span><span id="__span-0-111"><span class="hll">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span></span><span id="__span-0-112"><span class="hll">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span></span><span id="__span-0-113"><span class="hll">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span></span><span id="__span-0-114"><span class="hll">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span></span><span id="__span-0-115"><span class="hll">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span></span><span id="__span-0-116"><span class="hll">    <span class="p">)</span>
</span></span><span id="__span-0-117">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-0-118">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-0-119">        <span class="n">username</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-0-120">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-0-121">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-0-122"><span class="hll">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span></span><span id="__span-0-123"><span class="hll">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span></span><span id="__span-0-124"><span class="hll">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span></span><span id="__span-0-125"><span class="hll">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span></span><span id="__span-0-126"><span class="hll">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span></span><span id="__span-0-127">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-0-128">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-0-129">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-0-130"><span class="hll">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span></span><span id="__span-0-131"><span class="hll">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span></span><span id="__span-0-132"><span class="hll">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span></span><span id="__span-0-133"><span class="hll">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span></span><span id="__span-0-134"><span class="hll">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span></span><span id="__span-0-135"><span class="hll">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span></span><span id="__span-0-136"><span class="hll">            <span class="p">)</span>
</span></span><span id="__span-0-137">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-0-138">
</span><span id="__span-0-139">
</span><span id="__span-0-140"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-0-141"><span class="hll">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">])],</span>
</span></span><span id="__span-0-142"><span class="p">):</span>
</span><span id="__span-0-143">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-0-144">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-0-145">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-0-146">
</span><span id="__span-0-147">
</span><span id="__span-0-148"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-0-149"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-0-150">    <span class="n">form_data</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span> <span class="n">Depends</span><span class="p">()],</span>
</span><span id="__span-0-151"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-0-152">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-0-153">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-0-154">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-0-155">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-0-156">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-0-157"><span class="hll">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span></span><span id="__span-0-158">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-0-159">    <span class="p">)</span>
</span><span id="__span-0-160">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-0-161">
</span><span id="__span-0-162">
</span><span id="__span-0-163"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-0-164"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span>
</span><span id="__span-0-165">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)],</span>
</span><span id="__span-0-166"><span class="p">):</span>
</span><span id="__span-0-167">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-0-168">
</span><span id="__span-0-169">
</span><span id="__span-0-170"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-0-171"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-0-172">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">])],</span>
</span><span id="__span-0-173"><span class="p">):</span>
</span><span id="__span-0-174">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-0-175">
</span><span id="__span-0-176">
</span><span id="__span-0-177"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-0-178"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)]):</span>
</span><span id="__span-0-179">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
</div>
</div>
<details>
<summary>ü§ì Other versions and variants</summary>
<div class="tabbed-set tabbed-alternate" data-tabs="2:3"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><input id="__tabbed_2_3" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">Python 3.9+</label><label for="__tabbed_2_2">Python 3.10+ - non-Annotated</label><label for="__tabbed_2_3">Python 3.9+ - non-Annotated</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span id="__span-1-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-1-2"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span><span class="p">,</span> <span class="n">Union</span>
</span><span id="__span-1-3">
</span><span id="__span-1-4"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-1-5"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-1-6"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-1-7">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-1-8">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-1-9">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span><span id="__span-1-10"><span class="p">)</span>
</span><span id="__span-1-11"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-1-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-1-13"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-1-14">
</span><span id="__span-1-15"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-1-16"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-1-17"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-1-18"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-1-19"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-1-20">
</span><span id="__span-1-21">
</span><span id="__span-1-22"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-1-23">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-1-24">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-1-25">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-1-26">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-1-27">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-1-28">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-1-29">    <span class="p">},</span>
</span><span id="__span-1-30">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-1-31">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-1-32">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-1-33">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-1-34">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-1-35">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-1-36">    <span class="p">},</span>
</span><span id="__span-1-37"><span class="p">}</span>
</span><span id="__span-1-38">
</span><span id="__span-1-39">
</span><span id="__span-1-40"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-1-41">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-1-42">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-1-43">
</span><span id="__span-1-44">
</span><span id="__span-1-45"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-1-46">    <span class="n">username</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-1-47">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-1-48">
</span><span id="__span-1-49">
</span><span id="__span-1-50"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-1-51">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-1-52">    <span class="n">email</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-1-53">    <span class="n">full_name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-1-54">    <span class="n">disabled</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-1-55">
</span><span id="__span-1-56">
</span><span id="__span-1-57"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-1-58">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-1-59">
</span><span id="__span-1-60">
</span><span id="__span-1-61"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-1-62">
</span><span id="__span-1-63"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-1-64">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-1-65">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span><span id="__span-1-66"><span class="p">)</span>
</span><span id="__span-1-67">
</span><span id="__span-1-68"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-1-69">
</span><span id="__span-1-70">
</span><span id="__span-1-71"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-1-72">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-1-73">
</span><span id="__span-1-74">
</span><span id="__span-1-75"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-1-76">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-1-77">
</span><span id="__span-1-78">
</span><span id="__span-1-79"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-1-80">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-1-81">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-1-82">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-1-83">
</span><span id="__span-1-84">
</span><span id="__span-1-85"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-1-86">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-1-87">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-1-88">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-1-89">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-1-90">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-1-91">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-1-92">
</span><span id="__span-1-93">
</span><span id="__span-1-94"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">timedelta</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-1-95">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-1-96">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-1-97">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-1-98">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-1-99">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-1-100">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-1-101">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-1-102">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-1-103">
</span><span id="__span-1-104">
</span><span id="__span-1-105"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-1-106">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)]</span>
</span><span id="__span-1-107"><span class="p">):</span>
</span><span id="__span-1-108">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-1-109">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="__span-1-110">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-1-111">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span><span id="__span-1-112">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-1-113">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-1-114">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span><span id="__span-1-115">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-1-116">    <span class="p">)</span>
</span><span id="__span-1-117">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-1-118">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-1-119">        <span class="n">username</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-1-120">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-1-121">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-1-122">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-1-123">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-1-124">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-1-125">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span><span id="__span-1-126">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-1-127">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-1-128">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-1-129">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-1-130">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-1-131">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-1-132">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-1-133">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-1-134">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span><span id="__span-1-135">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-1-136">            <span class="p">)</span>
</span><span id="__span-1-137">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-1-138">
</span><span id="__span-1-139">
</span><span id="__span-1-140"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-1-141">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">])],</span>
</span><span id="__span-1-142"><span class="p">):</span>
</span><span id="__span-1-143">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-1-144">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-1-145">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-1-146">
</span><span id="__span-1-147">
</span><span id="__span-1-148"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-1-149"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-1-150">    <span class="n">form_data</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span> <span class="n">Depends</span><span class="p">()],</span>
</span><span id="__span-1-151"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-1-152">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-1-153">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-1-154">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-1-155">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-1-156">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-1-157">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span><span id="__span-1-158">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-1-159">    <span class="p">)</span>
</span><span id="__span-1-160">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-1-161">
</span><span id="__span-1-162">
</span><span id="__span-1-163"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-1-164"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span>
</span><span id="__span-1-165">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)],</span>
</span><span id="__span-1-166"><span class="p">):</span>
</span><span id="__span-1-167">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-1-168">
</span><span id="__span-1-169">
</span><span id="__span-1-170"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-1-171"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-1-172">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">])],</span>
</span><span id="__span-1-173"><span class="p">):</span>
</span><span id="__span-1-174">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-1-175">
</span><span id="__span-1-176">
</span><span id="__span-1-177"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-1-178"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)]):</span>
</span><span id="__span-1-179">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Prefer to use the <code>Annotated</code> version if possible.</p>
</div>
<div class="highlight"><pre><span></span><code><span id="__span-2-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-2-2">
</span><span id="__span-2-3"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-2-4"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-2-5"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-2-6">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-2-7">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-2-8">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span><span id="__span-2-9"><span class="p">)</span>
</span><span id="__span-2-10"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-2-11"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-2-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-2-13">
</span><span id="__span-2-14"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-2-15"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-2-16"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-2-17"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-2-18"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-2-19">
</span><span id="__span-2-20">
</span><span id="__span-2-21"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-2-22">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-2-23">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-2-24">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-2-25">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-2-26">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-2-27">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-2-28">    <span class="p">},</span>
</span><span id="__span-2-29">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-2-30">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-2-31">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-2-32">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-2-33">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-2-34">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-2-35">    <span class="p">},</span>
</span><span id="__span-2-36"><span class="p">}</span>
</span><span id="__span-2-37">
</span><span id="__span-2-38">
</span><span id="__span-2-39"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-2-40">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-2-41">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-2-42">
</span><span id="__span-2-43">
</span><span id="__span-2-44"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-2-45">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-2-46">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-2-47">
</span><span id="__span-2-48">
</span><span id="__span-2-49"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-2-50">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-2-51">    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-2-52">    <span class="n">full_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-2-53">    <span class="n">disabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-2-54">
</span><span id="__span-2-55">
</span><span id="__span-2-56"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-2-57">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-2-58">
</span><span id="__span-2-59">
</span><span id="__span-2-60"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-2-61">
</span><span id="__span-2-62"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-2-63">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-2-64">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span><span id="__span-2-65"><span class="p">)</span>
</span><span id="__span-2-66">
</span><span id="__span-2-67"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-2-68">
</span><span id="__span-2-69">
</span><span id="__span-2-70"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-2-71">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-2-72">
</span><span id="__span-2-73">
</span><span id="__span-2-74"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-2-75">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-2-76">
</span><span id="__span-2-77">
</span><span id="__span-2-78"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-2-79">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-2-80">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-2-81">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-2-82">
</span><span id="__span-2-83">
</span><span id="__span-2-84"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-2-85">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-2-86">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-2-87">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-2-88">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-2-89">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-2-90">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-2-91">
</span><span id="__span-2-92">
</span><span id="__span-2-93"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">timedelta</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-2-94">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-2-95">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-2-96">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-2-97">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-2-98">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-2-99">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-2-100">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-2-101">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-2-102">
</span><span id="__span-2-103">
</span><span id="__span-2-104"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-2-105">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)</span>
</span><span id="__span-2-106"><span class="p">):</span>
</span><span id="__span-2-107">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-2-108">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="__span-2-109">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-2-110">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span><span id="__span-2-111">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-2-112">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-2-113">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span><span id="__span-2-114">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-2-115">    <span class="p">)</span>
</span><span id="__span-2-116">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-2-117">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-2-118">        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-2-119">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-2-120">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-2-121">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-2-122">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-2-123">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-2-124">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span><span id="__span-2-125">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-2-126">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-2-127">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-2-128">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-2-129">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-2-130">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-2-131">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-2-132">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-2-133">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span><span id="__span-2-134">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-2-135">            <span class="p">)</span>
</span><span id="__span-2-136">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-2-137">
</span><span id="__span-2-138">
</span><span id="__span-2-139"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-2-140">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">]),</span>
</span><span id="__span-2-141"><span class="p">):</span>
</span><span id="__span-2-142">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-2-143">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-2-144">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-2-145">
</span><span id="__span-2-146">
</span><span id="__span-2-147"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-2-148"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-2-149">    <span class="n">form_data</span><span class="p">:</span> <span class="n">OAuth2PasswordRequestForm</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(),</span>
</span><span id="__span-2-150"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-2-151">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-2-152">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-2-153">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-2-154">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-2-155">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-2-156">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span><span id="__span-2-157">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-2-158">    <span class="p">)</span>
</span><span id="__span-2-159">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-2-160">
</span><span id="__span-2-161">
</span><span id="__span-2-162"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-2-163"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)):</span>
</span><span id="__span-2-164">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-2-165">
</span><span id="__span-2-166">
</span><span id="__span-2-167"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-2-168"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-2-169">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]),</span>
</span><span id="__span-2-170"><span class="p">):</span>
</span><span id="__span-2-171">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-2-172">
</span><span id="__span-2-173">
</span><span id="__span-2-174"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-2-175"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)):</span>
</span><span id="__span-2-176">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Prefer to use the <code>Annotated</code> version if possible.</p>
</div>
<div class="highlight"><pre><span></span><code><span id="__span-3-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-3-2"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span>
</span><span id="__span-3-3">
</span><span id="__span-3-4"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-3-5"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-3-6"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-3-7">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-3-8">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-3-9">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span><span id="__span-3-10"><span class="p">)</span>
</span><span id="__span-3-11"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-3-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-3-13"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-3-14">
</span><span id="__span-3-15"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-3-16"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-3-17"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-3-18"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-3-19"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-3-20">
</span><span id="__span-3-21">
</span><span id="__span-3-22"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-3-23">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-3-24">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-3-25">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-3-26">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-3-27">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-3-28">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-3-29">    <span class="p">},</span>
</span><span id="__span-3-30">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-3-31">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-3-32">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-3-33">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-3-34">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-3-35">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-3-36">    <span class="p">},</span>
</span><span id="__span-3-37"><span class="p">}</span>
</span><span id="__span-3-38">
</span><span id="__span-3-39">
</span><span id="__span-3-40"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-3-41">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-3-42">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-3-43">
</span><span id="__span-3-44">
</span><span id="__span-3-45"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-3-46">    <span class="n">username</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-3-47">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-3-48">
</span><span id="__span-3-49">
</span><span id="__span-3-50"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-3-51">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-3-52">    <span class="n">email</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-3-53">    <span class="n">full_name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-3-54">    <span class="n">disabled</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-3-55">
</span><span id="__span-3-56">
</span><span id="__span-3-57"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-3-58">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-3-59">
</span><span id="__span-3-60">
</span><span id="__span-3-61"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-3-62">
</span><span id="__span-3-63"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-3-64">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-3-65">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span><span id="__span-3-66"><span class="p">)</span>
</span><span id="__span-3-67">
</span><span id="__span-3-68"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-3-69">
</span><span id="__span-3-70">
</span><span id="__span-3-71"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-3-72">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-3-73">
</span><span id="__span-3-74">
</span><span id="__span-3-75"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-3-76">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-3-77">
</span><span id="__span-3-78">
</span><span id="__span-3-79"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-3-80">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-3-81">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-3-82">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-3-83">
</span><span id="__span-3-84">
</span><span id="__span-3-85"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-3-86">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-3-87">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-3-88">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-3-89">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-3-90">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-3-91">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-3-92">
</span><span id="__span-3-93">
</span><span id="__span-3-94"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">timedelta</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-3-95">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-3-96">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-3-97">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-3-98">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-3-99">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-3-100">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-3-101">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-3-102">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-3-103">
</span><span id="__span-3-104">
</span><span id="__span-3-105"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-3-106">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)</span>
</span><span id="__span-3-107"><span class="p">):</span>
</span><span id="__span-3-108">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-3-109">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="__span-3-110">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-3-111">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span><span id="__span-3-112">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-3-113">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-3-114">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span><span id="__span-3-115">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-3-116">    <span class="p">)</span>
</span><span id="__span-3-117">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-3-118">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-3-119">        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-3-120">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-3-121">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-3-122">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-3-123">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-3-124">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-3-125">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span><span id="__span-3-126">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-3-127">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-3-128">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-3-129">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-3-130">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-3-131">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-3-132">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-3-133">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-3-134">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span><span id="__span-3-135">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-3-136">            <span class="p">)</span>
</span><span id="__span-3-137">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-3-138">
</span><span id="__span-3-139">
</span><span id="__span-3-140"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-3-141">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">]),</span>
</span><span id="__span-3-142"><span class="p">):</span>
</span><span id="__span-3-143">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-3-144">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-3-145">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-3-146">
</span><span id="__span-3-147">
</span><span id="__span-3-148"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-3-149"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-3-150">    <span class="n">form_data</span><span class="p">:</span> <span class="n">OAuth2PasswordRequestForm</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(),</span>
</span><span id="__span-3-151"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-3-152">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-3-153">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-3-154">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-3-155">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-3-156">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-3-157">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span><span id="__span-3-158">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-3-159">    <span class="p">)</span>
</span><span id="__span-3-160">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-3-161">
</span><span id="__span-3-162">
</span><span id="__span-3-163"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-3-164"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)):</span>
</span><span id="__span-3-165">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-3-166">
</span><span id="__span-3-167">
</span><span id="__span-3-168"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-3-169"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-3-170">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]),</span>
</span><span id="__span-3-171"><span class="p">):</span>
</span><span id="__span-3-172">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-3-173">
</span><span id="__span-3-174">
</span><span id="__span-3-175"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-3-176"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)):</span>
</span><span id="__span-3-177">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
</div>
</div>
</details>
<p>Now let's review those changes step by step.</p>
<h2 id="oauth2-security-scheme">OAuth2 Security scheme<a class="headerlink" data-preview="" href="#oauth2-security-scheme" title="Permanent link">&para;</a></h2>
<p>The first change is that now we are declaring the OAuth2 security scheme with two available scopes, <code>me</code> and <code>items</code>.</p>
<p>The <code>scopes</code> parameter receives a <code>dict</code> with each scope as a key and the description as the value:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:1"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">Python 3.10+</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span id="__span-4-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-4-2"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>
</span><span id="__span-4-3">
</span><span id="__span-4-4"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-4-5"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-4-6"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-4-7">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-4-8">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-4-9">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span><span id="__span-4-10"><span class="p">)</span>
</span><span id="__span-4-11"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-4-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-4-13"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-4-14">
</span><span id="__span-4-15"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-4-16"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-4-17"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-4-18"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-4-19"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-4-20">
</span><span id="__span-4-21">
</span><span id="__span-4-22"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-4-23">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-4-24">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-4-25">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-4-26">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-4-27">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-4-28">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-4-29">    <span class="p">},</span>
</span><span id="__span-4-30">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-4-31">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-4-32">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-4-33">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-4-34">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-4-35">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-4-36">    <span class="p">},</span>
</span><span id="__span-4-37"><span class="p">}</span>
</span><span id="__span-4-38">
</span><span id="__span-4-39">
</span><span id="__span-4-40"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-4-41">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-4-42">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-4-43">
</span><span id="__span-4-44">
</span><span id="__span-4-45"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-4-46">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-4-47">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-4-48">
</span><span id="__span-4-49">
</span><span id="__span-4-50"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-4-51">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-4-52">    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-4-53">    <span class="n">full_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-4-54">    <span class="n">disabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-4-55">
</span><span id="__span-4-56">
</span><span id="__span-4-57"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-4-58">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-4-59">
</span><span id="__span-4-60">
</span><span id="__span-4-61"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-4-62">
</span><span id="__span-4-63"><span class="hll"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span></span><span id="__span-4-64"><span class="hll">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span></span><span id="__span-4-65"><span class="hll">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span></span><span id="__span-4-66"><span class="hll"><span class="p">)</span>
</span></span><span id="__span-4-67">
</span><span id="__span-4-68"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-4-69">
</span><span id="__span-4-70">
</span><span id="__span-4-71"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-4-72">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-4-73">
</span><span id="__span-4-74">
</span><span id="__span-4-75"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-4-76">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-4-77">
</span><span id="__span-4-78">
</span><span id="__span-4-79"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-4-80">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-4-81">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-4-82">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-4-83">
</span><span id="__span-4-84">
</span><span id="__span-4-85"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-4-86">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-4-87">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-4-88">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-4-89">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-4-90">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-4-91">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-4-92">
</span><span id="__span-4-93">
</span><span id="__span-4-94"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">timedelta</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-4-95">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-4-96">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-4-97">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-4-98">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-4-99">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-4-100">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-4-101">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-4-102">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-4-103">
</span><span id="__span-4-104">
</span><span id="__span-4-105"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-4-106">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)]</span>
</span><span id="__span-4-107"><span class="p">):</span>
</span><span id="__span-4-108">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-4-109">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="__span-4-110">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-4-111">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span><span id="__span-4-112">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-4-113">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-4-114">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span><span id="__span-4-115">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-4-116">    <span class="p">)</span>
</span><span id="__span-4-117">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-4-118">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-4-119">        <span class="n">username</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-4-120">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-4-121">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-4-122">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-4-123">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-4-124">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-4-125">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span><span id="__span-4-126">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-4-127">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-4-128">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-4-129">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-4-130">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-4-131">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-4-132">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-4-133">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-4-134">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span><span id="__span-4-135">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-4-136">            <span class="p">)</span>
</span><span id="__span-4-137">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-4-138">
</span><span id="__span-4-139">
</span><span id="__span-4-140"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-4-141">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">])],</span>
</span><span id="__span-4-142"><span class="p">):</span>
</span><span id="__span-4-143">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-4-144">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-4-145">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-4-146">
</span><span id="__span-4-147">
</span><span id="__span-4-148"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-4-149"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-4-150">    <span class="n">form_data</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span> <span class="n">Depends</span><span class="p">()],</span>
</span><span id="__span-4-151"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-4-152">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-4-153">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-4-154">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-4-155">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-4-156">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-4-157">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span><span id="__span-4-158">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-4-159">    <span class="p">)</span>
</span><span id="__span-4-160">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-4-161">
</span><span id="__span-4-162">
</span><span id="__span-4-163"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-4-164"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span>
</span><span id="__span-4-165">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)],</span>
</span><span id="__span-4-166"><span class="p">):</span>
</span><span id="__span-4-167">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-4-168">
</span><span id="__span-4-169">
</span><span id="__span-4-170"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-4-171"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-4-172">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">])],</span>
</span><span id="__span-4-173"><span class="p">):</span>
</span><span id="__span-4-174">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-4-175">
</span><span id="__span-4-176">
</span><span id="__span-4-177"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-4-178"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)]):</span>
</span><span id="__span-4-179">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
</div>
</div>
<details>
<summary>ü§ì Other versions and variants</summary>
<div class="tabbed-set tabbed-alternate" data-tabs="4:3"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><input id="__tabbed_4_2" name="__tabbed_4" type="radio" /><input id="__tabbed_4_3" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">Python 3.9+</label><label for="__tabbed_4_2">Python 3.10+ - non-Annotated</label><label for="__tabbed_4_3">Python 3.9+ - non-Annotated</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span id="__span-5-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-5-2"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span><span class="p">,</span> <span class="n">Union</span>
</span><span id="__span-5-3">
</span><span id="__span-5-4"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-5-5"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-5-6"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-5-7">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-5-8">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-5-9">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span><span id="__span-5-10"><span class="p">)</span>
</span><span id="__span-5-11"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-5-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-5-13"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-5-14">
</span><span id="__span-5-15"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-5-16"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-5-17"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-5-18"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-5-19"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-5-20">
</span><span id="__span-5-21">
</span><span id="__span-5-22"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-5-23">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-5-24">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-5-25">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-5-26">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-5-27">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-5-28">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-5-29">    <span class="p">},</span>
</span><span id="__span-5-30">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-5-31">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-5-32">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-5-33">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-5-34">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-5-35">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-5-36">    <span class="p">},</span>
</span><span id="__span-5-37"><span class="p">}</span>
</span><span id="__span-5-38">
</span><span id="__span-5-39">
</span><span id="__span-5-40"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-5-41">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-5-42">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-5-43">
</span><span id="__span-5-44">
</span><span id="__span-5-45"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-5-46">    <span class="n">username</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-5-47">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-5-48">
</span><span id="__span-5-49">
</span><span id="__span-5-50"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-5-51">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-5-52">    <span class="n">email</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-5-53">    <span class="n">full_name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-5-54">    <span class="n">disabled</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-5-55">
</span><span id="__span-5-56">
</span><span id="__span-5-57"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-5-58">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-5-59">
</span><span id="__span-5-60">
</span><span id="__span-5-61"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-5-62">
</span><span id="__span-5-63"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-5-64">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-5-65">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span><span id="__span-5-66"><span class="p">)</span>
</span><span id="__span-5-67">
</span><span id="__span-5-68"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-5-69">
</span><span id="__span-5-70">
</span><span id="__span-5-71"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-5-72">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-5-73">
</span><span id="__span-5-74">
</span><span id="__span-5-75"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-5-76">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-5-77">
</span><span id="__span-5-78">
</span><span id="__span-5-79"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-5-80">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-5-81">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-5-82">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-5-83">
</span><span id="__span-5-84">
</span><span id="__span-5-85"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-5-86">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-5-87">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-5-88">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-5-89">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-5-90">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-5-91">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-5-92">
</span><span id="__span-5-93">
</span><span id="__span-5-94"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">timedelta</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-5-95">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-5-96">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-5-97">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-5-98">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-5-99">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-5-100">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-5-101">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-5-102">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-5-103">
</span><span id="__span-5-104">
</span><span id="__span-5-105"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-5-106">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)]</span>
</span><span id="__span-5-107"><span class="p">):</span>
</span><span id="__span-5-108">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-5-109">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="__span-5-110">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-5-111">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span><span id="__span-5-112">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-5-113">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-5-114">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span><span id="__span-5-115">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-5-116">    <span class="p">)</span>
</span><span id="__span-5-117">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-5-118">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-5-119">        <span class="n">username</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-5-120">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-5-121">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-5-122">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-5-123">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-5-124">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-5-125">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span><span id="__span-5-126">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-5-127">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-5-128">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-5-129">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-5-130">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-5-131">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-5-132">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-5-133">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-5-134">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span><span id="__span-5-135">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-5-136">            <span class="p">)</span>
</span><span id="__span-5-137">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-5-138">
</span><span id="__span-5-139">
</span><span id="__span-5-140"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-5-141">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">])],</span>
</span><span id="__span-5-142"><span class="p">):</span>
</span><span id="__span-5-143">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-5-144">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-5-145">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-5-146">
</span><span id="__span-5-147">
</span><span id="__span-5-148"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-5-149"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-5-150">    <span class="n">form_data</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span> <span class="n">Depends</span><span class="p">()],</span>
</span><span id="__span-5-151"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-5-152">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-5-153">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-5-154">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-5-155">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-5-156">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-5-157">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span><span id="__span-5-158">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-5-159">    <span class="p">)</span>
</span><span id="__span-5-160">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-5-161">
</span><span id="__span-5-162">
</span><span id="__span-5-163"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-5-164"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span>
</span><span id="__span-5-165">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)],</span>
</span><span id="__span-5-166"><span class="p">):</span>
</span><span id="__span-5-167">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-5-168">
</span><span id="__span-5-169">
</span><span id="__span-5-170"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-5-171"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-5-172">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">])],</span>
</span><span id="__span-5-173"><span class="p">):</span>
</span><span id="__span-5-174">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-5-175">
</span><span id="__span-5-176">
</span><span id="__span-5-177"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-5-178"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)]):</span>
</span><span id="__span-5-179">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Prefer to use the <code>Annotated</code> version if possible.</p>
</div>
<div class="highlight"><pre><span></span><code><span id="__span-6-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-6-2">
</span><span id="__span-6-3"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-6-4"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-6-5"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-6-6">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-6-7">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-6-8">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span><span id="__span-6-9"><span class="p">)</span>
</span><span id="__span-6-10"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-6-11"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-6-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-6-13">
</span><span id="__span-6-14"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-6-15"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-6-16"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-6-17"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-6-18"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-6-19">
</span><span id="__span-6-20">
</span><span id="__span-6-21"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-6-22">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-6-23">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-6-24">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-6-25">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-6-26">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-6-27">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-6-28">    <span class="p">},</span>
</span><span id="__span-6-29">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-6-30">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-6-31">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-6-32">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-6-33">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-6-34">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-6-35">    <span class="p">},</span>
</span><span id="__span-6-36"><span class="p">}</span>
</span><span id="__span-6-37">
</span><span id="__span-6-38">
</span><span id="__span-6-39"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-6-40">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-6-41">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-6-42">
</span><span id="__span-6-43">
</span><span id="__span-6-44"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-6-45">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-6-46">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-6-47">
</span><span id="__span-6-48">
</span><span id="__span-6-49"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-6-50">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-6-51">    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-6-52">    <span class="n">full_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-6-53">    <span class="n">disabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-6-54">
</span><span id="__span-6-55">
</span><span id="__span-6-56"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-6-57">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-6-58">
</span><span id="__span-6-59">
</span><span id="__span-6-60"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-6-61">
</span><span id="__span-6-62"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-6-63">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-6-64">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span><span id="__span-6-65"><span class="p">)</span>
</span><span id="__span-6-66">
</span><span id="__span-6-67"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-6-68">
</span><span id="__span-6-69">
</span><span id="__span-6-70"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-6-71">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-6-72">
</span><span id="__span-6-73">
</span><span id="__span-6-74"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-6-75">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-6-76">
</span><span id="__span-6-77">
</span><span id="__span-6-78"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-6-79">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-6-80">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-6-81">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-6-82">
</span><span id="__span-6-83">
</span><span id="__span-6-84"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-6-85">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-6-86">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-6-87">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-6-88">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-6-89">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-6-90">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-6-91">
</span><span id="__span-6-92">
</span><span id="__span-6-93"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">timedelta</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-6-94">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-6-95">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-6-96">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-6-97">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-6-98">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-6-99">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-6-100">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-6-101">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-6-102">
</span><span id="__span-6-103">
</span><span id="__span-6-104"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-6-105">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)</span>
</span><span id="__span-6-106"><span class="p">):</span>
</span><span id="__span-6-107">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-6-108">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="__span-6-109">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-6-110">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span><span id="__span-6-111">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-6-112">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-6-113">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span><span id="__span-6-114">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-6-115">    <span class="p">)</span>
</span><span id="__span-6-116">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-6-117">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-6-118">        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-6-119">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-6-120">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-6-121">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-6-122">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-6-123">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-6-124">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span><span id="__span-6-125">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-6-126">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-6-127">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-6-128">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-6-129">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-6-130">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-6-131">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-6-132">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-6-133">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span><span id="__span-6-134">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-6-135">            <span class="p">)</span>
</span><span id="__span-6-136">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-6-137">
</span><span id="__span-6-138">
</span><span id="__span-6-139"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-6-140">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">]),</span>
</span><span id="__span-6-141"><span class="p">):</span>
</span><span id="__span-6-142">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-6-143">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-6-144">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-6-145">
</span><span id="__span-6-146">
</span><span id="__span-6-147"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-6-148"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-6-149">    <span class="n">form_data</span><span class="p">:</span> <span class="n">OAuth2PasswordRequestForm</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(),</span>
</span><span id="__span-6-150"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-6-151">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-6-152">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-6-153">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-6-154">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-6-155">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-6-156">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span><span id="__span-6-157">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-6-158">    <span class="p">)</span>
</span><span id="__span-6-159">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-6-160">
</span><span id="__span-6-161">
</span><span id="__span-6-162"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-6-163"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)):</span>
</span><span id="__span-6-164">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-6-165">
</span><span id="__span-6-166">
</span><span id="__span-6-167"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-6-168"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-6-169">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]),</span>
</span><span id="__span-6-170"><span class="p">):</span>
</span><span id="__span-6-171">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-6-172">
</span><span id="__span-6-173">
</span><span id="__span-6-174"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-6-175"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)):</span>
</span><span id="__span-6-176">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Prefer to use the <code>Annotated</code> version if possible.</p>
</div>
<div class="highlight"><pre><span></span><code><span id="__span-7-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-7-2"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span>
</span><span id="__span-7-3">
</span><span id="__span-7-4"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-7-5"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-7-6"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-7-7">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-7-8">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-7-9">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span><span id="__span-7-10"><span class="p">)</span>
</span><span id="__span-7-11"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-7-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-7-13"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-7-14">
</span><span id="__span-7-15"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-7-16"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-7-17"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-7-18"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-7-19"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-7-20">
</span><span id="__span-7-21">
</span><span id="__span-7-22"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-7-23">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-24">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-7-25">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-7-26">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-7-27">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-7-28">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-7-29">    <span class="p">},</span>
</span><span id="__span-7-30">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-31">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-7-32">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-7-33">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-7-34">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-7-35">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-7-36">    <span class="p">},</span>
</span><span id="__span-7-37"><span class="p">}</span>
</span><span id="__span-7-38">
</span><span id="__span-7-39">
</span><span id="__span-7-40"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-7-41">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-7-42">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-7-43">
</span><span id="__span-7-44">
</span><span id="__span-7-45"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-7-46">    <span class="n">username</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-7-47">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-7-48">
</span><span id="__span-7-49">
</span><span id="__span-7-50"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-7-51">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-7-52">    <span class="n">email</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-7-53">    <span class="n">full_name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-7-54">    <span class="n">disabled</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-7-55">
</span><span id="__span-7-56">
</span><span id="__span-7-57"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-7-58">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-7-59">
</span><span id="__span-7-60">
</span><span id="__span-7-61"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-7-62">
</span><span id="__span-7-63"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-7-64">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-7-65">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span><span id="__span-7-66"><span class="p">)</span>
</span><span id="__span-7-67">
</span><span id="__span-7-68"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-7-69">
</span><span id="__span-7-70">
</span><span id="__span-7-71"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-7-72">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-7-73">
</span><span id="__span-7-74">
</span><span id="__span-7-75"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-7-76">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-7-77">
</span><span id="__span-7-78">
</span><span id="__span-7-79"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-7-80">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-7-81">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-7-82">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-7-83">
</span><span id="__span-7-84">
</span><span id="__span-7-85"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-7-86">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-7-87">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-7-88">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-7-89">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-7-90">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-7-91">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-7-92">
</span><span id="__span-7-93">
</span><span id="__span-7-94"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">timedelta</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-7-95">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-7-96">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-7-97">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-7-98">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-7-99">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-7-100">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-7-101">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-7-102">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-7-103">
</span><span id="__span-7-104">
</span><span id="__span-7-105"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-7-106">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)</span>
</span><span id="__span-7-107"><span class="p">):</span>
</span><span id="__span-7-108">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-7-109">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="__span-7-110">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-7-111">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span><span id="__span-7-112">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-7-113">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-7-114">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span><span id="__span-7-115">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-7-116">    <span class="p">)</span>
</span><span id="__span-7-117">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-7-118">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-7-119">        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-7-120">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-7-121">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-7-122">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-7-123">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-7-124">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-7-125">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span><span id="__span-7-126">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-7-127">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-7-128">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-7-129">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-7-130">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-7-131">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-7-132">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-7-133">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-7-134">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span><span id="__span-7-135">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-7-136">            <span class="p">)</span>
</span><span id="__span-7-137">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-7-138">
</span><span id="__span-7-139">
</span><span id="__span-7-140"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-7-141">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">]),</span>
</span><span id="__span-7-142"><span class="p">):</span>
</span><span id="__span-7-143">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-7-144">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-7-145">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-7-146">
</span><span id="__span-7-147">
</span><span id="__span-7-148"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-7-149"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-7-150">    <span class="n">form_data</span><span class="p">:</span> <span class="n">OAuth2PasswordRequestForm</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(),</span>
</span><span id="__span-7-151"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-7-152">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-7-153">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-7-154">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-7-155">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-7-156">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-7-157">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span><span id="__span-7-158">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-7-159">    <span class="p">)</span>
</span><span id="__span-7-160">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-7-161">
</span><span id="__span-7-162">
</span><span id="__span-7-163"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-7-164"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)):</span>
</span><span id="__span-7-165">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-7-166">
</span><span id="__span-7-167">
</span><span id="__span-7-168"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-7-169"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-7-170">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]),</span>
</span><span id="__span-7-171"><span class="p">):</span>
</span><span id="__span-7-172">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-7-173">
</span><span id="__span-7-174">
</span><span id="__span-7-175"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-7-176"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)):</span>
</span><span id="__span-7-177">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
</div>
</div>
</details>
<p>Because we are now declaring those scopes, they will show up in the API docs when you log-in/authorize.</p>
<p>And you will be able to select which scopes you want to give access to: <code>me</code> and <code>items</code>.</p>
<p>This is the same mechanism used when you give permissions while logging in with Facebook, Google, GitHub, etc:</p>
<p><img src="/img/tutorial/security/image11.png"></p>
<h2 id="jwt-token-with-scopes">JWT token with scopes<a class="headerlink" data-preview="" href="#jwt-token-with-scopes" title="Permanent link">&para;</a></h2>
<p>Now, modify the token <em>path operation</em> to return the scopes requested.</p>
<p>We are still using the same <code>OAuth2PasswordRequestForm</code>. It includes a property <code>scopes</code> with a <code>list</code> of <code>str</code>, with each scope it received in the request.</p>
<p>And we return the scopes as part of the JWT token.</p>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>For simplicity, here we are just adding the scopes received directly to the token.</p>
<p>But in your application, for security, you should make sure you only add the scopes that the user is actually able to have, or the ones you have predefined.</p>
</div>
<div class="tabbed-set tabbed-alternate" data-tabs="5:1"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="__tabbed_5_1">Python 3.10+</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span id="__span-8-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-8-2"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>
</span><span id="__span-8-3">
</span><span id="__span-8-4"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-8-5"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-8-6"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-8-7">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-8-8">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-8-9">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span><span id="__span-8-10"><span class="p">)</span>
</span><span id="__span-8-11"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-8-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-8-13"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-8-14">
</span><span id="__span-8-15"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-8-16"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-8-17"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-8-18"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-8-19"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-8-20">
</span><span id="__span-8-21">
</span><span id="__span-8-22"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-8-23">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-8-24">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-8-25">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-8-26">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-8-27">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-8-28">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-8-29">    <span class="p">},</span>
</span><span id="__span-8-30">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-8-31">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-8-32">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-8-33">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-8-34">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-8-35">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-8-36">    <span class="p">},</span>
</span><span id="__span-8-37"><span class="p">}</span>
</span><span id="__span-8-38">
</span><span id="__span-8-39">
</span><span id="__span-8-40"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-8-41">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-8-42">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-8-43">
</span><span id="__span-8-44">
</span><span id="__span-8-45"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-8-46">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-8-47">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-8-48">
</span><span id="__span-8-49">
</span><span id="__span-8-50"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-8-51">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-8-52">    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-8-53">    <span class="n">full_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-8-54">    <span class="n">disabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-8-55">
</span><span id="__span-8-56">
</span><span id="__span-8-57"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-8-58">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-8-59">
</span><span id="__span-8-60">
</span><span id="__span-8-61"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-8-62">
</span><span id="__span-8-63"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-8-64">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-8-65">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span><span id="__span-8-66"><span class="p">)</span>
</span><span id="__span-8-67">
</span><span id="__span-8-68"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-8-69">
</span><span id="__span-8-70">
</span><span id="__span-8-71"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-8-72">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-8-73">
</span><span id="__span-8-74">
</span><span id="__span-8-75"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-8-76">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-8-77">
</span><span id="__span-8-78">
</span><span id="__span-8-79"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-8-80">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-8-81">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-8-82">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-8-83">
</span><span id="__span-8-84">
</span><span id="__span-8-85"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-8-86">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-8-87">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-8-88">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-8-89">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-8-90">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-8-91">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-8-92">
</span><span id="__span-8-93">
</span><span id="__span-8-94"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">timedelta</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-8-95">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-8-96">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-8-97">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-8-98">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-8-99">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-8-100">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-8-101">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-8-102">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-8-103">
</span><span id="__span-8-104">
</span><span id="__span-8-105"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-8-106">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)]</span>
</span><span id="__span-8-107"><span class="p">):</span>
</span><span id="__span-8-108">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-8-109">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="__span-8-110">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-8-111">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span><span id="__span-8-112">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-8-113">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-8-114">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span><span id="__span-8-115">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-8-116">    <span class="p">)</span>
</span><span id="__span-8-117">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-8-118">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-8-119">        <span class="n">username</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-8-120">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-8-121">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-8-122">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-8-123">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-8-124">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-8-125">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span><span id="__span-8-126">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-8-127">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-8-128">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-8-129">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-8-130">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-8-131">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-8-132">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-8-133">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-8-134">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span><span id="__span-8-135">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-8-136">            <span class="p">)</span>
</span><span id="__span-8-137">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-8-138">
</span><span id="__span-8-139">
</span><span id="__span-8-140"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-8-141">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">])],</span>
</span><span id="__span-8-142"><span class="p">):</span>
</span><span id="__span-8-143">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-8-144">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-8-145">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-8-146">
</span><span id="__span-8-147">
</span><span id="__span-8-148"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-8-149"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-8-150">    <span class="n">form_data</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span> <span class="n">Depends</span><span class="p">()],</span>
</span><span id="__span-8-151"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-8-152">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-8-153">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-8-154">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-8-155">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-8-156">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-8-157"><span class="hll">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span></span><span id="__span-8-158">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-8-159">    <span class="p">)</span>
</span><span id="__span-8-160">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-8-161">
</span><span id="__span-8-162">
</span><span id="__span-8-163"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-8-164"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span>
</span><span id="__span-8-165">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)],</span>
</span><span id="__span-8-166"><span class="p">):</span>
</span><span id="__span-8-167">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-8-168">
</span><span id="__span-8-169">
</span><span id="__span-8-170"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-8-171"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-8-172">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">])],</span>
</span><span id="__span-8-173"><span class="p">):</span>
</span><span id="__span-8-174">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-8-175">
</span><span id="__span-8-176">
</span><span id="__span-8-177"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-8-178"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)]):</span>
</span><span id="__span-8-179">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
</div>
</div>
<details>
<summary>ü§ì Other versions and variants</summary>
<div class="tabbed-set tabbed-alternate" data-tabs="6:3"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><input id="__tabbed_6_2" name="__tabbed_6" type="radio" /><input id="__tabbed_6_3" name="__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="__tabbed_6_1">Python 3.9+</label><label for="__tabbed_6_2">Python 3.10+ - non-Annotated</label><label for="__tabbed_6_3">Python 3.9+ - non-Annotated</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span id="__span-9-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-9-2"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span><span class="p">,</span> <span class="n">Union</span>
</span><span id="__span-9-3">
</span><span id="__span-9-4"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-9-5"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-9-6"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-9-7">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-9-8">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-9-9">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span><span id="__span-9-10"><span class="p">)</span>
</span><span id="__span-9-11"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-9-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-9-13"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-9-14">
</span><span id="__span-9-15"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-9-16"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-9-17"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-9-18"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-9-19"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-9-20">
</span><span id="__span-9-21">
</span><span id="__span-9-22"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-9-23">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-9-24">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-9-25">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-9-26">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-9-27">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-9-28">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-9-29">    <span class="p">},</span>
</span><span id="__span-9-30">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-9-31">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-9-32">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-9-33">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-9-34">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-9-35">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-9-36">    <span class="p">},</span>
</span><span id="__span-9-37"><span class="p">}</span>
</span><span id="__span-9-38">
</span><span id="__span-9-39">
</span><span id="__span-9-40"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-9-41">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-9-42">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-9-43">
</span><span id="__span-9-44">
</span><span id="__span-9-45"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-9-46">    <span class="n">username</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-9-47">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-9-48">
</span><span id="__span-9-49">
</span><span id="__span-9-50"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-9-51">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-9-52">    <span class="n">email</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-9-53">    <span class="n">full_name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-9-54">    <span class="n">disabled</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-9-55">
</span><span id="__span-9-56">
</span><span id="__span-9-57"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-9-58">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-9-59">
</span><span id="__span-9-60">
</span><span id="__span-9-61"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-9-62">
</span><span id="__span-9-63"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-9-64">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-9-65">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span><span id="__span-9-66"><span class="p">)</span>
</span><span id="__span-9-67">
</span><span id="__span-9-68"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-9-69">
</span><span id="__span-9-70">
</span><span id="__span-9-71"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-9-72">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-9-73">
</span><span id="__span-9-74">
</span><span id="__span-9-75"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-9-76">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-9-77">
</span><span id="__span-9-78">
</span><span id="__span-9-79"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-9-80">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-9-81">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-9-82">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-9-83">
</span><span id="__span-9-84">
</span><span id="__span-9-85"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-9-86">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-9-87">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-9-88">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-9-89">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-9-90">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-9-91">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-9-92">
</span><span id="__span-9-93">
</span><span id="__span-9-94"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">timedelta</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-9-95">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-9-96">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-9-97">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-9-98">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-9-99">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-9-100">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-9-101">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-9-102">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-9-103">
</span><span id="__span-9-104">
</span><span id="__span-9-105"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-9-106">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)]</span>
</span><span id="__span-9-107"><span class="p">):</span>
</span><span id="__span-9-108">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-9-109">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="__span-9-110">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-9-111">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span><span id="__span-9-112">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-9-113">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-9-114">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span><span id="__span-9-115">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-9-116">    <span class="p">)</span>
</span><span id="__span-9-117">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-9-118">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-9-119">        <span class="n">username</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-9-120">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-9-121">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-9-122">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-9-123">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-9-124">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-9-125">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span><span id="__span-9-126">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-9-127">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-9-128">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-9-129">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-9-130">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-9-131">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-9-132">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-9-133">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-9-134">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span><span id="__span-9-135">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-9-136">            <span class="p">)</span>
</span><span id="__span-9-137">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-9-138">
</span><span id="__span-9-139">
</span><span id="__span-9-140"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-9-141">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">])],</span>
</span><span id="__span-9-142"><span class="p">):</span>
</span><span id="__span-9-143">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-9-144">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-9-145">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-9-146">
</span><span id="__span-9-147">
</span><span id="__span-9-148"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-9-149"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-9-150">    <span class="n">form_data</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span> <span class="n">Depends</span><span class="p">()],</span>
</span><span id="__span-9-151"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-9-152">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-9-153">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-9-154">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-9-155">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-9-156">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-9-157">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span><span id="__span-9-158">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-9-159">    <span class="p">)</span>
</span><span id="__span-9-160">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-9-161">
</span><span id="__span-9-162">
</span><span id="__span-9-163"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-9-164"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span>
</span><span id="__span-9-165">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)],</span>
</span><span id="__span-9-166"><span class="p">):</span>
</span><span id="__span-9-167">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-9-168">
</span><span id="__span-9-169">
</span><span id="__span-9-170"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-9-171"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-9-172">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">])],</span>
</span><span id="__span-9-173"><span class="p">):</span>
</span><span id="__span-9-174">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-9-175">
</span><span id="__span-9-176">
</span><span id="__span-9-177"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-9-178"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)]):</span>
</span><span id="__span-9-179">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Prefer to use the <code>Annotated</code> version if possible.</p>
</div>
<div class="highlight"><pre><span></span><code><span id="__span-10-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-10-2">
</span><span id="__span-10-3"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-10-4"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-10-5"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-10-6">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-10-7">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-10-8">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span><span id="__span-10-9"><span class="p">)</span>
</span><span id="__span-10-10"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-10-11"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-10-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-10-13">
</span><span id="__span-10-14"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-10-15"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-10-16"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-10-17"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-10-18"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-10-19">
</span><span id="__span-10-20">
</span><span id="__span-10-21"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-10-22">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-10-23">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-10-24">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-10-25">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-10-26">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-10-27">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-10-28">    <span class="p">},</span>
</span><span id="__span-10-29">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-10-30">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-10-31">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-10-32">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-10-33">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-10-34">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-10-35">    <span class="p">},</span>
</span><span id="__span-10-36"><span class="p">}</span>
</span><span id="__span-10-37">
</span><span id="__span-10-38">
</span><span id="__span-10-39"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-10-40">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-10-41">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-10-42">
</span><span id="__span-10-43">
</span><span id="__span-10-44"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-10-45">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-10-46">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-10-47">
</span><span id="__span-10-48">
</span><span id="__span-10-49"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-10-50">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-10-51">    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-10-52">    <span class="n">full_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-10-53">    <span class="n">disabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-10-54">
</span><span id="__span-10-55">
</span><span id="__span-10-56"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-10-57">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-10-58">
</span><span id="__span-10-59">
</span><span id="__span-10-60"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-10-61">
</span><span id="__span-10-62"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-10-63">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-10-64">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span><span id="__span-10-65"><span class="p">)</span>
</span><span id="__span-10-66">
</span><span id="__span-10-67"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-10-68">
</span><span id="__span-10-69">
</span><span id="__span-10-70"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-10-71">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-10-72">
</span><span id="__span-10-73">
</span><span id="__span-10-74"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-10-75">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-10-76">
</span><span id="__span-10-77">
</span><span id="__span-10-78"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-10-79">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-10-80">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-10-81">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-10-82">
</span><span id="__span-10-83">
</span><span id="__span-10-84"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-10-85">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-10-86">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-10-87">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-10-88">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-10-89">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-10-90">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-10-91">
</span><span id="__span-10-92">
</span><span id="__span-10-93"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">timedelta</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-10-94">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-10-95">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-10-96">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-10-97">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-10-98">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-10-99">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-10-100">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-10-101">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-10-102">
</span><span id="__span-10-103">
</span><span id="__span-10-104"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-10-105">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)</span>
</span><span id="__span-10-106"><span class="p">):</span>
</span><span id="__span-10-107">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-10-108">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="__span-10-109">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-10-110">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span><span id="__span-10-111">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-10-112">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-10-113">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span><span id="__span-10-114">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-10-115">    <span class="p">)</span>
</span><span id="__span-10-116">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-10-117">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-10-118">        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-10-119">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-10-120">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-10-121">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-10-122">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-10-123">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-10-124">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span><span id="__span-10-125">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-10-126">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-10-127">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-10-128">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-10-129">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-10-130">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-10-131">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-10-132">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-10-133">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span><span id="__span-10-134">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-10-135">            <span class="p">)</span>
</span><span id="__span-10-136">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-10-137">
</span><span id="__span-10-138">
</span><span id="__span-10-139"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-10-140">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">]),</span>
</span><span id="__span-10-141"><span class="p">):</span>
</span><span id="__span-10-142">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-10-143">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-10-144">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-10-145">
</span><span id="__span-10-146">
</span><span id="__span-10-147"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-10-148"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-10-149">    <span class="n">form_data</span><span class="p">:</span> <span class="n">OAuth2PasswordRequestForm</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(),</span>
</span><span id="__span-10-150"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-10-151">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-10-152">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-10-153">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-10-154">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-10-155">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-10-156">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span><span id="__span-10-157">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-10-158">    <span class="p">)</span>
</span><span id="__span-10-159">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-10-160">
</span><span id="__span-10-161">
</span><span id="__span-10-162"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-10-163"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)):</span>
</span><span id="__span-10-164">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-10-165">
</span><span id="__span-10-166">
</span><span id="__span-10-167"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-10-168"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-10-169">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]),</span>
</span><span id="__span-10-170"><span class="p">):</span>
</span><span id="__span-10-171">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-10-172">
</span><span id="__span-10-173">
</span><span id="__span-10-174"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-10-175"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)):</span>
</span><span id="__span-10-176">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Prefer to use the <code>Annotated</code> version if possible.</p>
</div>
<div class="highlight"><pre><span></span><code><span id="__span-11-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-11-2"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span>
</span><span id="__span-11-3">
</span><span id="__span-11-4"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-11-5"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-11-6"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-11-7">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-11-8">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-11-9">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span><span id="__span-11-10"><span class="p">)</span>
</span><span id="__span-11-11"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-11-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-11-13"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-11-14">
</span><span id="__span-11-15"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-11-16"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-11-17"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-11-18"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-11-19"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-11-20">
</span><span id="__span-11-21">
</span><span id="__span-11-22"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-11-23">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-11-24">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-11-25">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-11-26">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-11-27">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-11-28">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-11-29">    <span class="p">},</span>
</span><span id="__span-11-30">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-11-31">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-11-32">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-11-33">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-11-34">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-11-35">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-11-36">    <span class="p">},</span>
</span><span id="__span-11-37"><span class="p">}</span>
</span><span id="__span-11-38">
</span><span id="__span-11-39">
</span><span id="__span-11-40"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-11-41">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-11-42">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-11-43">
</span><span id="__span-11-44">
</span><span id="__span-11-45"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-11-46">    <span class="n">username</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-11-47">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-11-48">
</span><span id="__span-11-49">
</span><span id="__span-11-50"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-11-51">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-11-52">    <span class="n">email</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-11-53">    <span class="n">full_name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-11-54">    <span class="n">disabled</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-11-55">
</span><span id="__span-11-56">
</span><span id="__span-11-57"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-11-58">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-11-59">
</span><span id="__span-11-60">
</span><span id="__span-11-61"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-11-62">
</span><span id="__span-11-63"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-11-64">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-11-65">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span><span id="__span-11-66"><span class="p">)</span>
</span><span id="__span-11-67">
</span><span id="__span-11-68"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-11-69">
</span><span id="__span-11-70">
</span><span id="__span-11-71"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-11-72">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-11-73">
</span><span id="__span-11-74">
</span><span id="__span-11-75"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-11-76">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-11-77">
</span><span id="__span-11-78">
</span><span id="__span-11-79"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-11-80">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-11-81">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-11-82">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-11-83">
</span><span id="__span-11-84">
</span><span id="__span-11-85"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-11-86">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-11-87">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-11-88">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-11-89">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-11-90">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-11-91">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-11-92">
</span><span id="__span-11-93">
</span><span id="__span-11-94"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">timedelta</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-11-95">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-11-96">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-11-97">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-11-98">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-11-99">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-11-100">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-11-101">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-11-102">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-11-103">
</span><span id="__span-11-104">
</span><span id="__span-11-105"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-11-106">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)</span>
</span><span id="__span-11-107"><span class="p">):</span>
</span><span id="__span-11-108">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-11-109">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="__span-11-110">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-11-111">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span><span id="__span-11-112">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-11-113">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-11-114">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span><span id="__span-11-115">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-11-116">    <span class="p">)</span>
</span><span id="__span-11-117">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-11-118">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-11-119">        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-11-120">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-11-121">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-11-122">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-11-123">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-11-124">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-11-125">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span><span id="__span-11-126">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-11-127">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-11-128">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-11-129">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-11-130">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-11-131">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-11-132">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-11-133">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-11-134">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span><span id="__span-11-135">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-11-136">            <span class="p">)</span>
</span><span id="__span-11-137">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-11-138">
</span><span id="__span-11-139">
</span><span id="__span-11-140"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-11-141">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">]),</span>
</span><span id="__span-11-142"><span class="p">):</span>
</span><span id="__span-11-143">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-11-144">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-11-145">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-11-146">
</span><span id="__span-11-147">
</span><span id="__span-11-148"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-11-149"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-11-150">    <span class="n">form_data</span><span class="p">:</span> <span class="n">OAuth2PasswordRequestForm</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(),</span>
</span><span id="__span-11-151"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-11-152">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-11-153">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-11-154">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-11-155">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-11-156">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-11-157">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span><span id="__span-11-158">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-11-159">    <span class="p">)</span>
</span><span id="__span-11-160">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-11-161">
</span><span id="__span-11-162">
</span><span id="__span-11-163"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-11-164"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)):</span>
</span><span id="__span-11-165">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-11-166">
</span><span id="__span-11-167">
</span><span id="__span-11-168"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-11-169"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-11-170">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]),</span>
</span><span id="__span-11-171"><span class="p">):</span>
</span><span id="__span-11-172">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-11-173">
</span><span id="__span-11-174">
</span><span id="__span-11-175"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-11-176"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)):</span>
</span><span id="__span-11-177">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
</div>
</div>
</details>
<h2 id="declare-scopes-in-path-operations-and-dependencies">Declare scopes in <em>path operations</em> and dependencies<a class="headerlink" data-preview="" href="#declare-scopes-in-path-operations-and-dependencies" title="Permanent link">&para;</a></h2>
<p>Now we declare that the <em>path operation</em> for <code>/users/me/items/</code> requires the scope <code>items</code>.</p>
<p>For this, we import and use <code>Security</code> from <code>fastapi</code>.</p>
<p>You can use <code>Security</code> to declare dependencies (just like <code>Depends</code>), but <code>Security</code> also receives a parameter <code>scopes</code> with a list of scopes (strings).</p>
<p>In this case, we pass a dependency function <code>get_current_active_user</code> to <code>Security</code> (the same way we would do with <code>Depends</code>).</p>
<p>But we also pass a <code>list</code> of scopes, in this case with just one scope: <code>items</code> (it could have more).</p>
<p>And the dependency function <code>get_current_active_user</code> can also declare sub-dependencies, not only with <code>Depends</code> but also with <code>Security</code>. Declaring its own sub-dependency function (<code>get_current_user</code>), and more scope requirements.</p>
<p>In this case, it requires the scope <code>me</code> (it could require more than one scope).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You don't necessarily need to add different scopes in different places.</p>
<p>We are doing it here to demonstrate how <strong>FastAPI</strong> handles scopes declared at different levels.</p>
</div>
<div class="tabbed-set tabbed-alternate" data-tabs="7:1"><input checked="checked" id="__tabbed_7_1" name="__tabbed_7" type="radio" /><div class="tabbed-labels"><label for="__tabbed_7_1">Python 3.10+</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span id="__span-12-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-12-2"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>
</span><span id="__span-12-3">
</span><span id="__span-12-4"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-12-5"><span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span></span><span id="__span-12-6"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-12-7">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-12-8">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-12-9">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span><span id="__span-12-10"><span class="p">)</span>
</span><span id="__span-12-11"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-12-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-12-13"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-12-14">
</span><span id="__span-12-15"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-12-16"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-12-17"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-12-18"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-12-19"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-12-20">
</span><span id="__span-12-21">
</span><span id="__span-12-22"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-12-23">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-12-24">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-12-25">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-12-26">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-12-27">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-12-28">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-12-29">    <span class="p">},</span>
</span><span id="__span-12-30">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-12-31">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-12-32">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-12-33">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-12-34">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-12-35">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-12-36">    <span class="p">},</span>
</span><span id="__span-12-37"><span class="p">}</span>
</span><span id="__span-12-38">
</span><span id="__span-12-39">
</span><span id="__span-12-40"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-12-41">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-12-42">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-12-43">
</span><span id="__span-12-44">
</span><span id="__span-12-45"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-12-46">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-12-47">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-12-48">
</span><span id="__span-12-49">
</span><span id="__span-12-50"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-12-51">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-12-52">    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-12-53">    <span class="n">full_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-12-54">    <span class="n">disabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-12-55">
</span><span id="__span-12-56">
</span><span id="__span-12-57"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-12-58">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-12-59">
</span><span id="__span-12-60">
</span><span id="__span-12-61"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-12-62">
</span><span id="__span-12-63"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-12-64">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-12-65">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span><span id="__span-12-66"><span class="p">)</span>
</span><span id="__span-12-67">
</span><span id="__span-12-68"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-12-69">
</span><span id="__span-12-70">
</span><span id="__span-12-71"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-12-72">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-12-73">
</span><span id="__span-12-74">
</span><span id="__span-12-75"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-12-76">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-12-77">
</span><span id="__span-12-78">
</span><span id="__span-12-79"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-12-80">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-12-81">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-12-82">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-12-83">
</span><span id="__span-12-84">
</span><span id="__span-12-85"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-12-86">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-12-87">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-12-88">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-12-89">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-12-90">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-12-91">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-12-92">
</span><span id="__span-12-93">
</span><span id="__span-12-94"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">timedelta</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-12-95">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-12-96">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-12-97">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-12-98">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-12-99">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-12-100">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-12-101">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-12-102">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-12-103">
</span><span id="__span-12-104">
</span><span id="__span-12-105"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-12-106">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)]</span>
</span><span id="__span-12-107"><span class="p">):</span>
</span><span id="__span-12-108">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-12-109">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="__span-12-110">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-12-111">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span><span id="__span-12-112">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-12-113">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-12-114">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span><span id="__span-12-115">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-12-116">    <span class="p">)</span>
</span><span id="__span-12-117">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-12-118">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-12-119">        <span class="n">username</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-12-120">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-12-121">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-12-122">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-12-123">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-12-124">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-12-125">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span><span id="__span-12-126">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-12-127">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-12-128">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-12-129">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-12-130">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-12-131">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-12-132">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-12-133">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-12-134">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span><span id="__span-12-135">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-12-136">            <span class="p">)</span>
</span><span id="__span-12-137">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-12-138">
</span><span id="__span-12-139">
</span><span id="__span-12-140"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-12-141"><span class="hll">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">])],</span>
</span></span><span id="__span-12-142"><span class="p">):</span>
</span><span id="__span-12-143">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-12-144">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-12-145">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-12-146">
</span><span id="__span-12-147">
</span><span id="__span-12-148"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-12-149"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-12-150">    <span class="n">form_data</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span> <span class="n">Depends</span><span class="p">()],</span>
</span><span id="__span-12-151"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-12-152">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-12-153">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-12-154">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-12-155">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-12-156">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-12-157">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span><span id="__span-12-158">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-12-159">    <span class="p">)</span>
</span><span id="__span-12-160">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-12-161">
</span><span id="__span-12-162">
</span><span id="__span-12-163"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-12-164"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span>
</span><span id="__span-12-165">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)],</span>
</span><span id="__span-12-166"><span class="p">):</span>
</span><span id="__span-12-167">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-12-168">
</span><span id="__span-12-169">
</span><span id="__span-12-170"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-12-171"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-12-172"><span class="hll">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">])],</span>
</span></span><span id="__span-12-173"><span class="p">):</span>
</span><span id="__span-12-174">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-12-175">
</span><span id="__span-12-176">
</span><span id="__span-12-177"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-12-178"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)]):</span>
</span><span id="__span-12-179">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
</div>
</div>
<details>
<summary>ü§ì Other versions and variants</summary>
<div class="tabbed-set tabbed-alternate" data-tabs="8:3"><input checked="checked" id="__tabbed_8_1" name="__tabbed_8" type="radio" /><input id="__tabbed_8_2" name="__tabbed_8" type="radio" /><input id="__tabbed_8_3" name="__tabbed_8" type="radio" /><div class="tabbed-labels"><label for="__tabbed_8_1">Python 3.9+</label><label for="__tabbed_8_2">Python 3.10+ - non-Annotated</label><label for="__tabbed_8_3">Python 3.9+ - non-Annotated</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span id="__span-13-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-13-2"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span><span class="p">,</span> <span class="n">Union</span>
</span><span id="__span-13-3">
</span><span id="__span-13-4"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-13-5"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-13-6"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-13-7">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-13-8">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-13-9">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span><span id="__span-13-10"><span class="p">)</span>
</span><span id="__span-13-11"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-13-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-13-13"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-13-14">
</span><span id="__span-13-15"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-13-16"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-13-17"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-13-18"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-13-19"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-13-20">
</span><span id="__span-13-21">
</span><span id="__span-13-22"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-13-23">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-13-24">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-13-25">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-13-26">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-13-27">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-13-28">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-13-29">    <span class="p">},</span>
</span><span id="__span-13-30">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-13-31">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-13-32">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-13-33">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-13-34">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-13-35">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-13-36">    <span class="p">},</span>
</span><span id="__span-13-37"><span class="p">}</span>
</span><span id="__span-13-38">
</span><span id="__span-13-39">
</span><span id="__span-13-40"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-13-41">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-13-42">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-13-43">
</span><span id="__span-13-44">
</span><span id="__span-13-45"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-13-46">    <span class="n">username</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-13-47">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-13-48">
</span><span id="__span-13-49">
</span><span id="__span-13-50"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-13-51">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-13-52">    <span class="n">email</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-13-53">    <span class="n">full_name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-13-54">    <span class="n">disabled</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-13-55">
</span><span id="__span-13-56">
</span><span id="__span-13-57"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-13-58">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-13-59">
</span><span id="__span-13-60">
</span><span id="__span-13-61"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-13-62">
</span><span id="__span-13-63"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-13-64">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-13-65">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span><span id="__span-13-66"><span class="p">)</span>
</span><span id="__span-13-67">
</span><span id="__span-13-68"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-13-69">
</span><span id="__span-13-70">
</span><span id="__span-13-71"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-13-72">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-13-73">
</span><span id="__span-13-74">
</span><span id="__span-13-75"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-13-76">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-13-77">
</span><span id="__span-13-78">
</span><span id="__span-13-79"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-13-80">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-13-81">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-13-82">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-13-83">
</span><span id="__span-13-84">
</span><span id="__span-13-85"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-13-86">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-13-87">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-13-88">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-13-89">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-13-90">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-13-91">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-13-92">
</span><span id="__span-13-93">
</span><span id="__span-13-94"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">timedelta</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-13-95">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-13-96">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-13-97">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-13-98">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-13-99">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-13-100">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-13-101">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-13-102">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-13-103">
</span><span id="__span-13-104">
</span><span id="__span-13-105"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-13-106">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)]</span>
</span><span id="__span-13-107"><span class="p">):</span>
</span><span id="__span-13-108">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-13-109">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="__span-13-110">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-13-111">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span><span id="__span-13-112">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-13-113">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-13-114">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span><span id="__span-13-115">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-13-116">    <span class="p">)</span>
</span><span id="__span-13-117">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-13-118">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-13-119">        <span class="n">username</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-13-120">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-13-121">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-13-122">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-13-123">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-13-124">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-13-125">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span><span id="__span-13-126">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-13-127">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-13-128">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-13-129">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-13-130">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-13-131">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-13-132">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-13-133">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-13-134">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span><span id="__span-13-135">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-13-136">            <span class="p">)</span>
</span><span id="__span-13-137">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-13-138">
</span><span id="__span-13-139">
</span><span id="__span-13-140"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-13-141">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">])],</span>
</span><span id="__span-13-142"><span class="p">):</span>
</span><span id="__span-13-143">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-13-144">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-13-145">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-13-146">
</span><span id="__span-13-147">
</span><span id="__span-13-148"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-13-149"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-13-150">    <span class="n">form_data</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span> <span class="n">Depends</span><span class="p">()],</span>
</span><span id="__span-13-151"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-13-152">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-13-153">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-13-154">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-13-155">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-13-156">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-13-157">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span><span id="__span-13-158">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-13-159">    <span class="p">)</span>
</span><span id="__span-13-160">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-13-161">
</span><span id="__span-13-162">
</span><span id="__span-13-163"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-13-164"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span>
</span><span id="__span-13-165">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)],</span>
</span><span id="__span-13-166"><span class="p">):</span>
</span><span id="__span-13-167">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-13-168">
</span><span id="__span-13-169">
</span><span id="__span-13-170"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-13-171"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-13-172">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">])],</span>
</span><span id="__span-13-173"><span class="p">):</span>
</span><span id="__span-13-174">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-13-175">
</span><span id="__span-13-176">
</span><span id="__span-13-177"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-13-178"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)]):</span>
</span><span id="__span-13-179">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Prefer to use the <code>Annotated</code> version if possible.</p>
</div>
<div class="highlight"><pre><span></span><code><span id="__span-14-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-14-2">
</span><span id="__span-14-3"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-14-4"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-14-5"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-14-6">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-14-7">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-14-8">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span><span id="__span-14-9"><span class="p">)</span>
</span><span id="__span-14-10"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-14-11"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-14-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-14-13">
</span><span id="__span-14-14"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-14-15"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-14-16"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-14-17"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-14-18"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-14-19">
</span><span id="__span-14-20">
</span><span id="__span-14-21"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-14-22">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-14-23">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-14-24">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-14-25">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-14-26">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-14-27">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-14-28">    <span class="p">},</span>
</span><span id="__span-14-29">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-14-30">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-14-31">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-14-32">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-14-33">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-14-34">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-14-35">    <span class="p">},</span>
</span><span id="__span-14-36"><span class="p">}</span>
</span><span id="__span-14-37">
</span><span id="__span-14-38">
</span><span id="__span-14-39"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-14-40">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-14-41">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-14-42">
</span><span id="__span-14-43">
</span><span id="__span-14-44"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-14-45">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-14-46">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-14-47">
</span><span id="__span-14-48">
</span><span id="__span-14-49"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-14-50">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-14-51">    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-14-52">    <span class="n">full_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-14-53">    <span class="n">disabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-14-54">
</span><span id="__span-14-55">
</span><span id="__span-14-56"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-14-57">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-14-58">
</span><span id="__span-14-59">
</span><span id="__span-14-60"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-14-61">
</span><span id="__span-14-62"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-14-63">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-14-64">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span><span id="__span-14-65"><span class="p">)</span>
</span><span id="__span-14-66">
</span><span id="__span-14-67"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-14-68">
</span><span id="__span-14-69">
</span><span id="__span-14-70"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-14-71">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-14-72">
</span><span id="__span-14-73">
</span><span id="__span-14-74"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-14-75">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-14-76">
</span><span id="__span-14-77">
</span><span id="__span-14-78"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-14-79">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-14-80">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-14-81">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-14-82">
</span><span id="__span-14-83">
</span><span id="__span-14-84"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-14-85">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-14-86">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-14-87">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-14-88">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-14-89">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-14-90">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-14-91">
</span><span id="__span-14-92">
</span><span id="__span-14-93"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">timedelta</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-14-94">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-14-95">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-14-96">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-14-97">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-14-98">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-14-99">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-14-100">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-14-101">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-14-102">
</span><span id="__span-14-103">
</span><span id="__span-14-104"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-14-105">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)</span>
</span><span id="__span-14-106"><span class="p">):</span>
</span><span id="__span-14-107">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-14-108">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="__span-14-109">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-14-110">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span><span id="__span-14-111">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-14-112">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-14-113">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span><span id="__span-14-114">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-14-115">    <span class="p">)</span>
</span><span id="__span-14-116">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-14-117">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-14-118">        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-14-119">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-14-120">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-14-121">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-14-122">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-14-123">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-14-124">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span><span id="__span-14-125">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-14-126">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-14-127">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-14-128">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-14-129">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-14-130">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-14-131">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-14-132">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-14-133">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span><span id="__span-14-134">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-14-135">            <span class="p">)</span>
</span><span id="__span-14-136">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-14-137">
</span><span id="__span-14-138">
</span><span id="__span-14-139"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-14-140">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">]),</span>
</span><span id="__span-14-141"><span class="p">):</span>
</span><span id="__span-14-142">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-14-143">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-14-144">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-14-145">
</span><span id="__span-14-146">
</span><span id="__span-14-147"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-14-148"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-14-149">    <span class="n">form_data</span><span class="p">:</span> <span class="n">OAuth2PasswordRequestForm</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(),</span>
</span><span id="__span-14-150"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-14-151">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-14-152">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-14-153">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-14-154">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-14-155">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-14-156">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span><span id="__span-14-157">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-14-158">    <span class="p">)</span>
</span><span id="__span-14-159">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-14-160">
</span><span id="__span-14-161">
</span><span id="__span-14-162"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-14-163"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)):</span>
</span><span id="__span-14-164">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-14-165">
</span><span id="__span-14-166">
</span><span id="__span-14-167"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-14-168"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-14-169">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]),</span>
</span><span id="__span-14-170"><span class="p">):</span>
</span><span id="__span-14-171">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-14-172">
</span><span id="__span-14-173">
</span><span id="__span-14-174"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-14-175"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)):</span>
</span><span id="__span-14-176">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Prefer to use the <code>Annotated</code> version if possible.</p>
</div>
<div class="highlight"><pre><span></span><code><span id="__span-15-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-15-2"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span>
</span><span id="__span-15-3">
</span><span id="__span-15-4"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-15-5"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-15-6"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-15-7">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-15-8">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-15-9">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span><span id="__span-15-10"><span class="p">)</span>
</span><span id="__span-15-11"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-15-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-15-13"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-15-14">
</span><span id="__span-15-15"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-15-16"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-15-17"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-15-18"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-15-19"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-15-20">
</span><span id="__span-15-21">
</span><span id="__span-15-22"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-15-23">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-15-24">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-15-25">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-15-26">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-15-27">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-15-28">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-15-29">    <span class="p">},</span>
</span><span id="__span-15-30">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-15-31">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-15-32">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-15-33">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-15-34">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-15-35">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-15-36">    <span class="p">},</span>
</span><span id="__span-15-37"><span class="p">}</span>
</span><span id="__span-15-38">
</span><span id="__span-15-39">
</span><span id="__span-15-40"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-15-41">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-15-42">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-15-43">
</span><span id="__span-15-44">
</span><span id="__span-15-45"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-15-46">    <span class="n">username</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-15-47">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-15-48">
</span><span id="__span-15-49">
</span><span id="__span-15-50"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-15-51">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-15-52">    <span class="n">email</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-15-53">    <span class="n">full_name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-15-54">    <span class="n">disabled</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-15-55">
</span><span id="__span-15-56">
</span><span id="__span-15-57"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-15-58">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-15-59">
</span><span id="__span-15-60">
</span><span id="__span-15-61"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-15-62">
</span><span id="__span-15-63"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-15-64">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-15-65">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span><span id="__span-15-66"><span class="p">)</span>
</span><span id="__span-15-67">
</span><span id="__span-15-68"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-15-69">
</span><span id="__span-15-70">
</span><span id="__span-15-71"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-15-72">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-15-73">
</span><span id="__span-15-74">
</span><span id="__span-15-75"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-15-76">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-15-77">
</span><span id="__span-15-78">
</span><span id="__span-15-79"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-15-80">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-15-81">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-15-82">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-15-83">
</span><span id="__span-15-84">
</span><span id="__span-15-85"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-15-86">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-15-87">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-15-88">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-15-89">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-15-90">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-15-91">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-15-92">
</span><span id="__span-15-93">
</span><span id="__span-15-94"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">timedelta</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-15-95">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-15-96">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-15-97">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-15-98">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-15-99">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-15-100">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-15-101">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-15-102">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-15-103">
</span><span id="__span-15-104">
</span><span id="__span-15-105"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-15-106">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)</span>
</span><span id="__span-15-107"><span class="p">):</span>
</span><span id="__span-15-108">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-15-109">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="__span-15-110">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-15-111">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span><span id="__span-15-112">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-15-113">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-15-114">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span><span id="__span-15-115">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-15-116">    <span class="p">)</span>
</span><span id="__span-15-117">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-15-118">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-15-119">        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-15-120">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-15-121">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-15-122">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-15-123">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-15-124">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-15-125">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span><span id="__span-15-126">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-15-127">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-15-128">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-15-129">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-15-130">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-15-131">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-15-132">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-15-133">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-15-134">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span><span id="__span-15-135">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-15-136">            <span class="p">)</span>
</span><span id="__span-15-137">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-15-138">
</span><span id="__span-15-139">
</span><span id="__span-15-140"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-15-141">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">]),</span>
</span><span id="__span-15-142"><span class="p">):</span>
</span><span id="__span-15-143">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-15-144">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-15-145">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-15-146">
</span><span id="__span-15-147">
</span><span id="__span-15-148"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-15-149"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-15-150">    <span class="n">form_data</span><span class="p">:</span> <span class="n">OAuth2PasswordRequestForm</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(),</span>
</span><span id="__span-15-151"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-15-152">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-15-153">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-15-154">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-15-155">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-15-156">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-15-157">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span><span id="__span-15-158">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-15-159">    <span class="p">)</span>
</span><span id="__span-15-160">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-15-161">
</span><span id="__span-15-162">
</span><span id="__span-15-163"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-15-164"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)):</span>
</span><span id="__span-15-165">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-15-166">
</span><span id="__span-15-167">
</span><span id="__span-15-168"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-15-169"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-15-170">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]),</span>
</span><span id="__span-15-171"><span class="p">):</span>
</span><span id="__span-15-172">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-15-173">
</span><span id="__span-15-174">
</span><span id="__span-15-175"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-15-176"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)):</span>
</span><span id="__span-15-177">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
</div>
</div>
</details>
<div class="admonition info">
<p class="admonition-title">Technical Details</p>
<p><code>Security</code> is actually a subclass of <code>Depends</code>, and it has just one extra parameter that we'll see later.</p>
<p>But by using <code>Security</code> instead of <code>Depends</code>, <strong>FastAPI</strong> will know that it can declare security scopes, use them internally, and document the API with OpenAPI.</p>
<p>But when you import <code>Query</code>, <code>Path</code>, <code>Depends</code>, <code>Security</code> and others from <code>fastapi</code>, those are actually functions that return special classes.</p>
</div>
<h2 id="use-securityscopes">Use <code>SecurityScopes</code><a class="headerlink" data-preview="" href="#use-securityscopes" title="Permanent link">&para;</a></h2>
<p>Now update the dependency <code>get_current_user</code>.</p>
<p>This is the one used by the dependencies above.</p>
<p>Here's where we are using the same OAuth2 scheme we created before, declaring it as a dependency: <code>oauth2_scheme</code>.</p>
<p>Because this dependency function doesn't have any scope requirements itself, we can use <code>Depends</code> with <code>oauth2_scheme</code>, we don't have to use <code>Security</code> when we don't need to specify security scopes.</p>
<p>We also declare a special parameter of type <code>SecurityScopes</code>, imported from <code>fastapi.security</code>.</p>
<p>This <code>SecurityScopes</code> class is similar to <code>Request</code> (<code>Request</code> was used to get the request object directly).</p>
<div class="tabbed-set tabbed-alternate" data-tabs="9:1"><input checked="checked" id="__tabbed_9_1" name="__tabbed_9" type="radio" /><div class="tabbed-labels"><label for="__tabbed_9_1">Python 3.10+</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span id="__span-16-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-16-2"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>
</span><span id="__span-16-3">
</span><span id="__span-16-4"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-16-5"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-16-6"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-16-7">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-16-8">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-16-9"><span class="hll">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span></span><span id="__span-16-10"><span class="p">)</span>
</span><span id="__span-16-11"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-16-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-16-13"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-16-14">
</span><span id="__span-16-15"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-16-16"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-16-17"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-16-18"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-16-19"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-16-20">
</span><span id="__span-16-21">
</span><span id="__span-16-22"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-16-23">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-16-24">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-16-25">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-16-26">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-16-27">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-16-28">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-16-29">    <span class="p">},</span>
</span><span id="__span-16-30">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-16-31">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-16-32">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-16-33">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-16-34">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-16-35">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-16-36">    <span class="p">},</span>
</span><span id="__span-16-37"><span class="p">}</span>
</span><span id="__span-16-38">
</span><span id="__span-16-39">
</span><span id="__span-16-40"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-16-41">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-16-42">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-16-43">
</span><span id="__span-16-44">
</span><span id="__span-16-45"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-16-46">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-16-47">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-16-48">
</span><span id="__span-16-49">
</span><span id="__span-16-50"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-16-51">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-16-52">    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-16-53">    <span class="n">full_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-16-54">    <span class="n">disabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-16-55">
</span><span id="__span-16-56">
</span><span id="__span-16-57"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-16-58">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-16-59">
</span><span id="__span-16-60">
</span><span id="__span-16-61"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-16-62">
</span><span id="__span-16-63"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-16-64">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-16-65">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span><span id="__span-16-66"><span class="p">)</span>
</span><span id="__span-16-67">
</span><span id="__span-16-68"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-16-69">
</span><span id="__span-16-70">
</span><span id="__span-16-71"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-16-72">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-16-73">
</span><span id="__span-16-74">
</span><span id="__span-16-75"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-16-76">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-16-77">
</span><span id="__span-16-78">
</span><span id="__span-16-79"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-16-80">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-16-81">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-16-82">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-16-83">
</span><span id="__span-16-84">
</span><span id="__span-16-85"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-16-86">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-16-87">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-16-88">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-16-89">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-16-90">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-16-91">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-16-92">
</span><span id="__span-16-93">
</span><span id="__span-16-94"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">timedelta</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-16-95">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-16-96">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-16-97">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-16-98">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-16-99">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-16-100">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-16-101">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-16-102">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-16-103">
</span><span id="__span-16-104">
</span><span id="__span-16-105"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-16-106"><span class="hll">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)]</span>
</span></span><span id="__span-16-107"><span class="p">):</span>
</span><span id="__span-16-108">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-16-109">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="__span-16-110">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-16-111">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span><span id="__span-16-112">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-16-113">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-16-114">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span><span id="__span-16-115">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-16-116">    <span class="p">)</span>
</span><span id="__span-16-117">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-16-118">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-16-119">        <span class="n">username</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-16-120">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-16-121">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-16-122">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-16-123">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-16-124">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-16-125">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span><span id="__span-16-126">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-16-127">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-16-128">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-16-129">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-16-130">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-16-131">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-16-132">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-16-133">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-16-134">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span><span id="__span-16-135">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-16-136">            <span class="p">)</span>
</span><span id="__span-16-137">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-16-138">
</span><span id="__span-16-139">
</span><span id="__span-16-140"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-16-141">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">])],</span>
</span><span id="__span-16-142"><span class="p">):</span>
</span><span id="__span-16-143">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-16-144">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-16-145">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-16-146">
</span><span id="__span-16-147">
</span><span id="__span-16-148"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-16-149"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-16-150">    <span class="n">form_data</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span> <span class="n">Depends</span><span class="p">()],</span>
</span><span id="__span-16-151"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-16-152">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-16-153">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-16-154">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-16-155">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-16-156">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-16-157">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span><span id="__span-16-158">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-16-159">    <span class="p">)</span>
</span><span id="__span-16-160">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-16-161">
</span><span id="__span-16-162">
</span><span id="__span-16-163"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-16-164"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span>
</span><span id="__span-16-165">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)],</span>
</span><span id="__span-16-166"><span class="p">):</span>
</span><span id="__span-16-167">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-16-168">
</span><span id="__span-16-169">
</span><span id="__span-16-170"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-16-171"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-16-172">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">])],</span>
</span><span id="__span-16-173"><span class="p">):</span>
</span><span id="__span-16-174">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-16-175">
</span><span id="__span-16-176">
</span><span id="__span-16-177"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-16-178"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)]):</span>
</span><span id="__span-16-179">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
</div>
</div>
<details>
<summary>ü§ì Other versions and variants</summary>
<div class="tabbed-set tabbed-alternate" data-tabs="10:3"><input checked="checked" id="__tabbed_10_1" name="__tabbed_10" type="radio" /><input id="__tabbed_10_2" name="__tabbed_10" type="radio" /><input id="__tabbed_10_3" name="__tabbed_10" type="radio" /><div class="tabbed-labels"><label for="__tabbed_10_1">Python 3.9+</label><label for="__tabbed_10_2">Python 3.10+ - non-Annotated</label><label for="__tabbed_10_3">Python 3.9+ - non-Annotated</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span id="__span-17-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-17-2"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span><span class="p">,</span> <span class="n">Union</span>
</span><span id="__span-17-3">
</span><span id="__span-17-4"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-17-5"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-17-6"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-17-7">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-17-8">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-17-9">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span><span id="__span-17-10"><span class="p">)</span>
</span><span id="__span-17-11"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-17-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-17-13"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-17-14">
</span><span id="__span-17-15"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-17-16"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-17-17"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-17-18"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-17-19"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-17-20">
</span><span id="__span-17-21">
</span><span id="__span-17-22"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-17-23">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-17-24">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-17-25">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-17-26">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-17-27">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-17-28">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-17-29">    <span class="p">},</span>
</span><span id="__span-17-30">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-17-31">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-17-32">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-17-33">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-17-34">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-17-35">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-17-36">    <span class="p">},</span>
</span><span id="__span-17-37"><span class="p">}</span>
</span><span id="__span-17-38">
</span><span id="__span-17-39">
</span><span id="__span-17-40"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-17-41">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-17-42">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-17-43">
</span><span id="__span-17-44">
</span><span id="__span-17-45"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-17-46">    <span class="n">username</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-17-47">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-17-48">
</span><span id="__span-17-49">
</span><span id="__span-17-50"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-17-51">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-17-52">    <span class="n">email</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-17-53">    <span class="n">full_name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-17-54">    <span class="n">disabled</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-17-55">
</span><span id="__span-17-56">
</span><span id="__span-17-57"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-17-58">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-17-59">
</span><span id="__span-17-60">
</span><span id="__span-17-61"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-17-62">
</span><span id="__span-17-63"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-17-64">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-17-65">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span><span id="__span-17-66"><span class="p">)</span>
</span><span id="__span-17-67">
</span><span id="__span-17-68"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-17-69">
</span><span id="__span-17-70">
</span><span id="__span-17-71"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-17-72">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-17-73">
</span><span id="__span-17-74">
</span><span id="__span-17-75"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-17-76">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-17-77">
</span><span id="__span-17-78">
</span><span id="__span-17-79"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-17-80">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-17-81">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-17-82">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-17-83">
</span><span id="__span-17-84">
</span><span id="__span-17-85"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-17-86">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-17-87">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-17-88">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-17-89">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-17-90">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-17-91">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-17-92">
</span><span id="__span-17-93">
</span><span id="__span-17-94"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">timedelta</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-17-95">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-17-96">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-17-97">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-17-98">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-17-99">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-17-100">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-17-101">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-17-102">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-17-103">
</span><span id="__span-17-104">
</span><span id="__span-17-105"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-17-106">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)]</span>
</span><span id="__span-17-107"><span class="p">):</span>
</span><span id="__span-17-108">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-17-109">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="__span-17-110">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-17-111">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span><span id="__span-17-112">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-17-113">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-17-114">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span><span id="__span-17-115">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-17-116">    <span class="p">)</span>
</span><span id="__span-17-117">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-17-118">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-17-119">        <span class="n">username</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-17-120">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-17-121">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-17-122">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-17-123">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-17-124">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-17-125">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span><span id="__span-17-126">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-17-127">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-17-128">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-17-129">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-17-130">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-17-131">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-17-132">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-17-133">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-17-134">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span><span id="__span-17-135">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-17-136">            <span class="p">)</span>
</span><span id="__span-17-137">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-17-138">
</span><span id="__span-17-139">
</span><span id="__span-17-140"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-17-141">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">])],</span>
</span><span id="__span-17-142"><span class="p">):</span>
</span><span id="__span-17-143">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-17-144">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-17-145">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-17-146">
</span><span id="__span-17-147">
</span><span id="__span-17-148"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-17-149"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-17-150">    <span class="n">form_data</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span> <span class="n">Depends</span><span class="p">()],</span>
</span><span id="__span-17-151"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-17-152">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-17-153">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-17-154">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-17-155">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-17-156">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-17-157">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span><span id="__span-17-158">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-17-159">    <span class="p">)</span>
</span><span id="__span-17-160">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-17-161">
</span><span id="__span-17-162">
</span><span id="__span-17-163"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-17-164"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span>
</span><span id="__span-17-165">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)],</span>
</span><span id="__span-17-166"><span class="p">):</span>
</span><span id="__span-17-167">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-17-168">
</span><span id="__span-17-169">
</span><span id="__span-17-170"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-17-171"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-17-172">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">])],</span>
</span><span id="__span-17-173"><span class="p">):</span>
</span><span id="__span-17-174">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-17-175">
</span><span id="__span-17-176">
</span><span id="__span-17-177"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-17-178"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)]):</span>
</span><span id="__span-17-179">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Prefer to use the <code>Annotated</code> version if possible.</p>
</div>
<div class="highlight"><pre><span></span><code><span id="__span-18-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-18-2">
</span><span id="__span-18-3"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-18-4"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-18-5"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-18-6">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-18-7">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-18-8">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span><span id="__span-18-9"><span class="p">)</span>
</span><span id="__span-18-10"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-18-11"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-18-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-18-13">
</span><span id="__span-18-14"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-18-15"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-18-16"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-18-17"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-18-18"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-18-19">
</span><span id="__span-18-20">
</span><span id="__span-18-21"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-18-22">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-18-23">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-18-24">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-18-25">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-18-26">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-18-27">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-18-28">    <span class="p">},</span>
</span><span id="__span-18-29">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-18-30">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-18-31">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-18-32">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-18-33">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-18-34">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-18-35">    <span class="p">},</span>
</span><span id="__span-18-36"><span class="p">}</span>
</span><span id="__span-18-37">
</span><span id="__span-18-38">
</span><span id="__span-18-39"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-18-40">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-18-41">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-18-42">
</span><span id="__span-18-43">
</span><span id="__span-18-44"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-18-45">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-18-46">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-18-47">
</span><span id="__span-18-48">
</span><span id="__span-18-49"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-18-50">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-18-51">    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-18-52">    <span class="n">full_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-18-53">    <span class="n">disabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-18-54">
</span><span id="__span-18-55">
</span><span id="__span-18-56"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-18-57">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-18-58">
</span><span id="__span-18-59">
</span><span id="__span-18-60"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-18-61">
</span><span id="__span-18-62"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-18-63">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-18-64">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span><span id="__span-18-65"><span class="p">)</span>
</span><span id="__span-18-66">
</span><span id="__span-18-67"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-18-68">
</span><span id="__span-18-69">
</span><span id="__span-18-70"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-18-71">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-18-72">
</span><span id="__span-18-73">
</span><span id="__span-18-74"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-18-75">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-18-76">
</span><span id="__span-18-77">
</span><span id="__span-18-78"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-18-79">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-18-80">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-18-81">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-18-82">
</span><span id="__span-18-83">
</span><span id="__span-18-84"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-18-85">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-18-86">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-18-87">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-18-88">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-18-89">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-18-90">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-18-91">
</span><span id="__span-18-92">
</span><span id="__span-18-93"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">timedelta</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-18-94">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-18-95">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-18-96">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-18-97">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-18-98">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-18-99">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-18-100">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-18-101">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-18-102">
</span><span id="__span-18-103">
</span><span id="__span-18-104"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-18-105">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)</span>
</span><span id="__span-18-106"><span class="p">):</span>
</span><span id="__span-18-107">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-18-108">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="__span-18-109">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-18-110">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span><span id="__span-18-111">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-18-112">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-18-113">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span><span id="__span-18-114">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-18-115">    <span class="p">)</span>
</span><span id="__span-18-116">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-18-117">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-18-118">        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-18-119">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-18-120">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-18-121">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-18-122">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-18-123">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-18-124">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span><span id="__span-18-125">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-18-126">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-18-127">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-18-128">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-18-129">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-18-130">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-18-131">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-18-132">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-18-133">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span><span id="__span-18-134">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-18-135">            <span class="p">)</span>
</span><span id="__span-18-136">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-18-137">
</span><span id="__span-18-138">
</span><span id="__span-18-139"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-18-140">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">]),</span>
</span><span id="__span-18-141"><span class="p">):</span>
</span><span id="__span-18-142">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-18-143">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-18-144">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-18-145">
</span><span id="__span-18-146">
</span><span id="__span-18-147"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-18-148"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-18-149">    <span class="n">form_data</span><span class="p">:</span> <span class="n">OAuth2PasswordRequestForm</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(),</span>
</span><span id="__span-18-150"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-18-151">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-18-152">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-18-153">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-18-154">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-18-155">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-18-156">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span><span id="__span-18-157">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-18-158">    <span class="p">)</span>
</span><span id="__span-18-159">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-18-160">
</span><span id="__span-18-161">
</span><span id="__span-18-162"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-18-163"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)):</span>
</span><span id="__span-18-164">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-18-165">
</span><span id="__span-18-166">
</span><span id="__span-18-167"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-18-168"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-18-169">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]),</span>
</span><span id="__span-18-170"><span class="p">):</span>
</span><span id="__span-18-171">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-18-172">
</span><span id="__span-18-173">
</span><span id="__span-18-174"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-18-175"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)):</span>
</span><span id="__span-18-176">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Prefer to use the <code>Annotated</code> version if possible.</p>
</div>
<div class="highlight"><pre><span></span><code><span id="__span-19-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-19-2"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span>
</span><span id="__span-19-3">
</span><span id="__span-19-4"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-19-5"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-19-6"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-19-7">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-19-8">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-19-9">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span><span id="__span-19-10"><span class="p">)</span>
</span><span id="__span-19-11"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-19-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-19-13"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-19-14">
</span><span id="__span-19-15"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-19-16"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-19-17"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-19-18"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-19-19"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-19-20">
</span><span id="__span-19-21">
</span><span id="__span-19-22"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-19-23">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-19-24">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-19-25">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-19-26">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-19-27">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-19-28">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-19-29">    <span class="p">},</span>
</span><span id="__span-19-30">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-19-31">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-19-32">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-19-33">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-19-34">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-19-35">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-19-36">    <span class="p">},</span>
</span><span id="__span-19-37"><span class="p">}</span>
</span><span id="__span-19-38">
</span><span id="__span-19-39">
</span><span id="__span-19-40"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-19-41">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-19-42">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-19-43">
</span><span id="__span-19-44">
</span><span id="__span-19-45"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-19-46">    <span class="n">username</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-19-47">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-19-48">
</span><span id="__span-19-49">
</span><span id="__span-19-50"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-19-51">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-19-52">    <span class="n">email</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-19-53">    <span class="n">full_name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-19-54">    <span class="n">disabled</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-19-55">
</span><span id="__span-19-56">
</span><span id="__span-19-57"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-19-58">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-19-59">
</span><span id="__span-19-60">
</span><span id="__span-19-61"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-19-62">
</span><span id="__span-19-63"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-19-64">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-19-65">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span><span id="__span-19-66"><span class="p">)</span>
</span><span id="__span-19-67">
</span><span id="__span-19-68"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-19-69">
</span><span id="__span-19-70">
</span><span id="__span-19-71"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-19-72">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-19-73">
</span><span id="__span-19-74">
</span><span id="__span-19-75"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-19-76">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-19-77">
</span><span id="__span-19-78">
</span><span id="__span-19-79"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-19-80">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-19-81">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-19-82">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-19-83">
</span><span id="__span-19-84">
</span><span id="__span-19-85"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-19-86">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-19-87">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-19-88">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-19-89">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-19-90">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-19-91">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-19-92">
</span><span id="__span-19-93">
</span><span id="__span-19-94"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">timedelta</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-19-95">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-19-96">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-19-97">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-19-98">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-19-99">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-19-100">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-19-101">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-19-102">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-19-103">
</span><span id="__span-19-104">
</span><span id="__span-19-105"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-19-106">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)</span>
</span><span id="__span-19-107"><span class="p">):</span>
</span><span id="__span-19-108">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-19-109">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="__span-19-110">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-19-111">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span><span id="__span-19-112">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-19-113">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-19-114">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span><span id="__span-19-115">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-19-116">    <span class="p">)</span>
</span><span id="__span-19-117">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-19-118">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-19-119">        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-19-120">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-19-121">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-19-122">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-19-123">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-19-124">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-19-125">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span><span id="__span-19-126">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-19-127">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-19-128">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-19-129">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-19-130">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-19-131">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-19-132">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-19-133">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-19-134">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span><span id="__span-19-135">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-19-136">            <span class="p">)</span>
</span><span id="__span-19-137">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-19-138">
</span><span id="__span-19-139">
</span><span id="__span-19-140"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-19-141">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">]),</span>
</span><span id="__span-19-142"><span class="p">):</span>
</span><span id="__span-19-143">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-19-144">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-19-145">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-19-146">
</span><span id="__span-19-147">
</span><span id="__span-19-148"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-19-149"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-19-150">    <span class="n">form_data</span><span class="p">:</span> <span class="n">OAuth2PasswordRequestForm</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(),</span>
</span><span id="__span-19-151"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-19-152">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-19-153">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-19-154">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-19-155">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-19-156">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-19-157">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span><span id="__span-19-158">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-19-159">    <span class="p">)</span>
</span><span id="__span-19-160">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-19-161">
</span><span id="__span-19-162">
</span><span id="__span-19-163"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-19-164"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)):</span>
</span><span id="__span-19-165">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-19-166">
</span><span id="__span-19-167">
</span><span id="__span-19-168"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-19-169"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-19-170">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]),</span>
</span><span id="__span-19-171"><span class="p">):</span>
</span><span id="__span-19-172">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-19-173">
</span><span id="__span-19-174">
</span><span id="__span-19-175"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-19-176"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)):</span>
</span><span id="__span-19-177">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
</div>
</div>
</details>
<h2 id="use-the-scopes">Use the <code>scopes</code><a class="headerlink" data-preview="" href="#use-the-scopes" title="Permanent link">&para;</a></h2>
<p>The parameter <code>security_scopes</code> will be of type <code>SecurityScopes</code>.</p>
<p>It will have a property <code>scopes</code> with a list containing all the scopes required by itself and all the dependencies that use this as a sub-dependency. That means, all the "dependants"... this might sound confusing, it is explained again later below.</p>
<p>The <code>security_scopes</code> object (of class <code>SecurityScopes</code>) also provides a <code>scope_str</code> attribute with a single string, containing those scopes separated by spaces (we are going to use it).</p>
<p>We create an <code>HTTPException</code> that we can reuse (<code>raise</code>) later at several points.</p>
<p>In this exception, we include the scopes required (if any) as a string separated by spaces (using <code>scope_str</code>). We put that string containing the scopes in the <code>WWW-Authenticate</code> header (this is part of the spec).</p>
<div class="tabbed-set tabbed-alternate" data-tabs="11:1"><input checked="checked" id="__tabbed_11_1" name="__tabbed_11" type="radio" /><div class="tabbed-labels"><label for="__tabbed_11_1">Python 3.10+</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span id="__span-20-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-20-2"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>
</span><span id="__span-20-3">
</span><span id="__span-20-4"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-20-5"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-20-6"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-20-7">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-20-8">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-20-9">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span><span id="__span-20-10"><span class="p">)</span>
</span><span id="__span-20-11"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-20-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-20-13"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-20-14">
</span><span id="__span-20-15"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-20-16"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-20-17"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-20-18"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-20-19"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-20-20">
</span><span id="__span-20-21">
</span><span id="__span-20-22"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-20-23">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-20-24">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-20-25">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-20-26">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-20-27">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-20-28">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-20-29">    <span class="p">},</span>
</span><span id="__span-20-30">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-20-31">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-20-32">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-20-33">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-20-34">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-20-35">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-20-36">    <span class="p">},</span>
</span><span id="__span-20-37"><span class="p">}</span>
</span><span id="__span-20-38">
</span><span id="__span-20-39">
</span><span id="__span-20-40"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-20-41">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-20-42">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-20-43">
</span><span id="__span-20-44">
</span><span id="__span-20-45"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-20-46">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-20-47">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-20-48">
</span><span id="__span-20-49">
</span><span id="__span-20-50"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-20-51">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-20-52">    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-20-53">    <span class="n">full_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-20-54">    <span class="n">disabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-20-55">
</span><span id="__span-20-56">
</span><span id="__span-20-57"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-20-58">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-20-59">
</span><span id="__span-20-60">
</span><span id="__span-20-61"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-20-62">
</span><span id="__span-20-63"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-20-64">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-20-65">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span><span id="__span-20-66"><span class="p">)</span>
</span><span id="__span-20-67">
</span><span id="__span-20-68"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-20-69">
</span><span id="__span-20-70">
</span><span id="__span-20-71"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-20-72">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-20-73">
</span><span id="__span-20-74">
</span><span id="__span-20-75"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-20-76">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-20-77">
</span><span id="__span-20-78">
</span><span id="__span-20-79"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-20-80">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-20-81">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-20-82">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-20-83">
</span><span id="__span-20-84">
</span><span id="__span-20-85"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-20-86">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-20-87">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-20-88">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-20-89">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-20-90">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-20-91">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-20-92">
</span><span id="__span-20-93">
</span><span id="__span-20-94"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">timedelta</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-20-95">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-20-96">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-20-97">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-20-98">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-20-99">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-20-100">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-20-101">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-20-102">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-20-103">
</span><span id="__span-20-104">
</span><span id="__span-20-105"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-20-106"><span class="hll">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)]</span>
</span></span><span id="__span-20-107"><span class="p">):</span>
</span><span id="__span-20-108"><span class="hll">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span></span><span id="__span-20-109"><span class="hll">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span></span><span id="__span-20-110"><span class="hll">    <span class="k">else</span><span class="p">:</span>
</span></span><span id="__span-20-111"><span class="hll">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span></span><span id="__span-20-112"><span class="hll">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span></span><span id="__span-20-113"><span class="hll">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span></span><span id="__span-20-114"><span class="hll">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span></span><span id="__span-20-115"><span class="hll">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span></span><span id="__span-20-116"><span class="hll">    <span class="p">)</span>
</span></span><span id="__span-20-117">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-20-118">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-20-119">        <span class="n">username</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-20-120">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-20-121">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-20-122">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-20-123">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-20-124">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-20-125">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span><span id="__span-20-126">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-20-127">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-20-128">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-20-129">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-20-130">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-20-131">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-20-132">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-20-133">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-20-134">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span><span id="__span-20-135">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-20-136">            <span class="p">)</span>
</span><span id="__span-20-137">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-20-138">
</span><span id="__span-20-139">
</span><span id="__span-20-140"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-20-141">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">])],</span>
</span><span id="__span-20-142"><span class="p">):</span>
</span><span id="__span-20-143">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-20-144">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-20-145">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-20-146">
</span><span id="__span-20-147">
</span><span id="__span-20-148"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-20-149"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-20-150">    <span class="n">form_data</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span> <span class="n">Depends</span><span class="p">()],</span>
</span><span id="__span-20-151"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-20-152">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-20-153">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-20-154">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-20-155">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-20-156">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-20-157">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span><span id="__span-20-158">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-20-159">    <span class="p">)</span>
</span><span id="__span-20-160">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-20-161">
</span><span id="__span-20-162">
</span><span id="__span-20-163"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-20-164"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span>
</span><span id="__span-20-165">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)],</span>
</span><span id="__span-20-166"><span class="p">):</span>
</span><span id="__span-20-167">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-20-168">
</span><span id="__span-20-169">
</span><span id="__span-20-170"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-20-171"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-20-172">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">])],</span>
</span><span id="__span-20-173"><span class="p">):</span>
</span><span id="__span-20-174">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-20-175">
</span><span id="__span-20-176">
</span><span id="__span-20-177"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-20-178"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)]):</span>
</span><span id="__span-20-179">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
</div>
</div>
<details>
<summary>ü§ì Other versions and variants</summary>
<div class="tabbed-set tabbed-alternate" data-tabs="12:3"><input checked="checked" id="__tabbed_12_1" name="__tabbed_12" type="radio" /><input id="__tabbed_12_2" name="__tabbed_12" type="radio" /><input id="__tabbed_12_3" name="__tabbed_12" type="radio" /><div class="tabbed-labels"><label for="__tabbed_12_1">Python 3.9+</label><label for="__tabbed_12_2">Python 3.10+ - non-Annotated</label><label for="__tabbed_12_3">Python 3.9+ - non-Annotated</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span id="__span-21-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-21-2"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span><span class="p">,</span> <span class="n">Union</span>
</span><span id="__span-21-3">
</span><span id="__span-21-4"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-21-5"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-21-6"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-21-7">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-21-8">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-21-9">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span><span id="__span-21-10"><span class="p">)</span>
</span><span id="__span-21-11"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-21-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-21-13"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-21-14">
</span><span id="__span-21-15"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-21-16"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-21-17"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-21-18"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-21-19"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-21-20">
</span><span id="__span-21-21">
</span><span id="__span-21-22"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-21-23">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-21-24">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-21-25">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-21-26">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-21-27">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-21-28">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-21-29">    <span class="p">},</span>
</span><span id="__span-21-30">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-21-31">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-21-32">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-21-33">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-21-34">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-21-35">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-21-36">    <span class="p">},</span>
</span><span id="__span-21-37"><span class="p">}</span>
</span><span id="__span-21-38">
</span><span id="__span-21-39">
</span><span id="__span-21-40"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-21-41">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-21-42">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-21-43">
</span><span id="__span-21-44">
</span><span id="__span-21-45"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-21-46">    <span class="n">username</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-21-47">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-21-48">
</span><span id="__span-21-49">
</span><span id="__span-21-50"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-21-51">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-21-52">    <span class="n">email</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-21-53">    <span class="n">full_name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-21-54">    <span class="n">disabled</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-21-55">
</span><span id="__span-21-56">
</span><span id="__span-21-57"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-21-58">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-21-59">
</span><span id="__span-21-60">
</span><span id="__span-21-61"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-21-62">
</span><span id="__span-21-63"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-21-64">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-21-65">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span><span id="__span-21-66"><span class="p">)</span>
</span><span id="__span-21-67">
</span><span id="__span-21-68"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-21-69">
</span><span id="__span-21-70">
</span><span id="__span-21-71"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-21-72">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-21-73">
</span><span id="__span-21-74">
</span><span id="__span-21-75"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-21-76">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-21-77">
</span><span id="__span-21-78">
</span><span id="__span-21-79"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-21-80">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-21-81">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-21-82">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-21-83">
</span><span id="__span-21-84">
</span><span id="__span-21-85"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-21-86">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-21-87">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-21-88">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-21-89">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-21-90">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-21-91">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-21-92">
</span><span id="__span-21-93">
</span><span id="__span-21-94"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">timedelta</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-21-95">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-21-96">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-21-97">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-21-98">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-21-99">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-21-100">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-21-101">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-21-102">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-21-103">
</span><span id="__span-21-104">
</span><span id="__span-21-105"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-21-106">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)]</span>
</span><span id="__span-21-107"><span class="p">):</span>
</span><span id="__span-21-108">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-21-109">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="__span-21-110">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-21-111">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span><span id="__span-21-112">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-21-113">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-21-114">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span><span id="__span-21-115">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-21-116">    <span class="p">)</span>
</span><span id="__span-21-117">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-21-118">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-21-119">        <span class="n">username</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-21-120">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-21-121">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-21-122">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-21-123">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-21-124">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-21-125">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span><span id="__span-21-126">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-21-127">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-21-128">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-21-129">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-21-130">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-21-131">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-21-132">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-21-133">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-21-134">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span><span id="__span-21-135">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-21-136">            <span class="p">)</span>
</span><span id="__span-21-137">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-21-138">
</span><span id="__span-21-139">
</span><span id="__span-21-140"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-21-141">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">])],</span>
</span><span id="__span-21-142"><span class="p">):</span>
</span><span id="__span-21-143">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-21-144">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-21-145">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-21-146">
</span><span id="__span-21-147">
</span><span id="__span-21-148"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-21-149"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-21-150">    <span class="n">form_data</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span> <span class="n">Depends</span><span class="p">()],</span>
</span><span id="__span-21-151"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-21-152">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-21-153">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-21-154">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-21-155">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-21-156">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-21-157">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span><span id="__span-21-158">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-21-159">    <span class="p">)</span>
</span><span id="__span-21-160">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-21-161">
</span><span id="__span-21-162">
</span><span id="__span-21-163"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-21-164"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span>
</span><span id="__span-21-165">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)],</span>
</span><span id="__span-21-166"><span class="p">):</span>
</span><span id="__span-21-167">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-21-168">
</span><span id="__span-21-169">
</span><span id="__span-21-170"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-21-171"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-21-172">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">])],</span>
</span><span id="__span-21-173"><span class="p">):</span>
</span><span id="__span-21-174">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-21-175">
</span><span id="__span-21-176">
</span><span id="__span-21-177"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-21-178"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)]):</span>
</span><span id="__span-21-179">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Prefer to use the <code>Annotated</code> version if possible.</p>
</div>
<div class="highlight"><pre><span></span><code><span id="__span-22-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-22-2">
</span><span id="__span-22-3"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-22-4"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-22-5"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-22-6">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-22-7">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-22-8">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span><span id="__span-22-9"><span class="p">)</span>
</span><span id="__span-22-10"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-22-11"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-22-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-22-13">
</span><span id="__span-22-14"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-22-15"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-22-16"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-22-17"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-22-18"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-22-19">
</span><span id="__span-22-20">
</span><span id="__span-22-21"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-22-22">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-22-23">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-22-24">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-22-25">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-22-26">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-22-27">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-22-28">    <span class="p">},</span>
</span><span id="__span-22-29">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-22-30">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-22-31">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-22-32">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-22-33">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-22-34">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-22-35">    <span class="p">},</span>
</span><span id="__span-22-36"><span class="p">}</span>
</span><span id="__span-22-37">
</span><span id="__span-22-38">
</span><span id="__span-22-39"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-22-40">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-22-41">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-22-42">
</span><span id="__span-22-43">
</span><span id="__span-22-44"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-22-45">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-22-46">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-22-47">
</span><span id="__span-22-48">
</span><span id="__span-22-49"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-22-50">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-22-51">    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-22-52">    <span class="n">full_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-22-53">    <span class="n">disabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-22-54">
</span><span id="__span-22-55">
</span><span id="__span-22-56"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-22-57">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-22-58">
</span><span id="__span-22-59">
</span><span id="__span-22-60"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-22-61">
</span><span id="__span-22-62"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-22-63">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-22-64">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span><span id="__span-22-65"><span class="p">)</span>
</span><span id="__span-22-66">
</span><span id="__span-22-67"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-22-68">
</span><span id="__span-22-69">
</span><span id="__span-22-70"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-22-71">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-22-72">
</span><span id="__span-22-73">
</span><span id="__span-22-74"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-22-75">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-22-76">
</span><span id="__span-22-77">
</span><span id="__span-22-78"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-22-79">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-22-80">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-22-81">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-22-82">
</span><span id="__span-22-83">
</span><span id="__span-22-84"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-22-85">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-22-86">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-22-87">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-22-88">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-22-89">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-22-90">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-22-91">
</span><span id="__span-22-92">
</span><span id="__span-22-93"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">timedelta</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-22-94">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-22-95">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-22-96">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-22-97">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-22-98">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-22-99">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-22-100">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-22-101">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-22-102">
</span><span id="__span-22-103">
</span><span id="__span-22-104"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-22-105">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)</span>
</span><span id="__span-22-106"><span class="p">):</span>
</span><span id="__span-22-107">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-22-108">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="__span-22-109">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-22-110">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span><span id="__span-22-111">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-22-112">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-22-113">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span><span id="__span-22-114">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-22-115">    <span class="p">)</span>
</span><span id="__span-22-116">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-22-117">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-22-118">        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-22-119">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-22-120">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-22-121">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-22-122">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-22-123">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-22-124">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span><span id="__span-22-125">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-22-126">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-22-127">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-22-128">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-22-129">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-22-130">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-22-131">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-22-132">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-22-133">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span><span id="__span-22-134">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-22-135">            <span class="p">)</span>
</span><span id="__span-22-136">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-22-137">
</span><span id="__span-22-138">
</span><span id="__span-22-139"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-22-140">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">]),</span>
</span><span id="__span-22-141"><span class="p">):</span>
</span><span id="__span-22-142">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-22-143">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-22-144">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-22-145">
</span><span id="__span-22-146">
</span><span id="__span-22-147"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-22-148"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-22-149">    <span class="n">form_data</span><span class="p">:</span> <span class="n">OAuth2PasswordRequestForm</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(),</span>
</span><span id="__span-22-150"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-22-151">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-22-152">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-22-153">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-22-154">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-22-155">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-22-156">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span><span id="__span-22-157">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-22-158">    <span class="p">)</span>
</span><span id="__span-22-159">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-22-160">
</span><span id="__span-22-161">
</span><span id="__span-22-162"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-22-163"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)):</span>
</span><span id="__span-22-164">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-22-165">
</span><span id="__span-22-166">
</span><span id="__span-22-167"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-22-168"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-22-169">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]),</span>
</span><span id="__span-22-170"><span class="p">):</span>
</span><span id="__span-22-171">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-22-172">
</span><span id="__span-22-173">
</span><span id="__span-22-174"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-22-175"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)):</span>
</span><span id="__span-22-176">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Prefer to use the <code>Annotated</code> version if possible.</p>
</div>
<div class="highlight"><pre><span></span><code><span id="__span-23-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-23-2"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span>
</span><span id="__span-23-3">
</span><span id="__span-23-4"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-23-5"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-23-6"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-23-7">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-23-8">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-23-9">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span><span id="__span-23-10"><span class="p">)</span>
</span><span id="__span-23-11"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-23-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-23-13"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-23-14">
</span><span id="__span-23-15"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-23-16"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-23-17"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-23-18"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-23-19"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-23-20">
</span><span id="__span-23-21">
</span><span id="__span-23-22"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-23-23">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-23-24">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-23-25">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-23-26">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-23-27">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-23-28">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-23-29">    <span class="p">},</span>
</span><span id="__span-23-30">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-23-31">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-23-32">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-23-33">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-23-34">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-23-35">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-23-36">    <span class="p">},</span>
</span><span id="__span-23-37"><span class="p">}</span>
</span><span id="__span-23-38">
</span><span id="__span-23-39">
</span><span id="__span-23-40"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-23-41">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-23-42">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-23-43">
</span><span id="__span-23-44">
</span><span id="__span-23-45"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-23-46">    <span class="n">username</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-23-47">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-23-48">
</span><span id="__span-23-49">
</span><span id="__span-23-50"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-23-51">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-23-52">    <span class="n">email</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-23-53">    <span class="n">full_name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-23-54">    <span class="n">disabled</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-23-55">
</span><span id="__span-23-56">
</span><span id="__span-23-57"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-23-58">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-23-59">
</span><span id="__span-23-60">
</span><span id="__span-23-61"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-23-62">
</span><span id="__span-23-63"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-23-64">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-23-65">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span><span id="__span-23-66"><span class="p">)</span>
</span><span id="__span-23-67">
</span><span id="__span-23-68"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-23-69">
</span><span id="__span-23-70">
</span><span id="__span-23-71"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-23-72">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-23-73">
</span><span id="__span-23-74">
</span><span id="__span-23-75"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-23-76">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-23-77">
</span><span id="__span-23-78">
</span><span id="__span-23-79"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-23-80">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-23-81">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-23-82">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-23-83">
</span><span id="__span-23-84">
</span><span id="__span-23-85"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-23-86">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-23-87">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-23-88">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-23-89">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-23-90">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-23-91">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-23-92">
</span><span id="__span-23-93">
</span><span id="__span-23-94"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">timedelta</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-23-95">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-23-96">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-23-97">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-23-98">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-23-99">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-23-100">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-23-101">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-23-102">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-23-103">
</span><span id="__span-23-104">
</span><span id="__span-23-105"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-23-106">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)</span>
</span><span id="__span-23-107"><span class="p">):</span>
</span><span id="__span-23-108">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-23-109">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="__span-23-110">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-23-111">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span><span id="__span-23-112">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-23-113">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-23-114">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span><span id="__span-23-115">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-23-116">    <span class="p">)</span>
</span><span id="__span-23-117">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-23-118">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-23-119">        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-23-120">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-23-121">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-23-122">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-23-123">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-23-124">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-23-125">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span><span id="__span-23-126">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-23-127">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-23-128">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-23-129">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-23-130">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-23-131">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-23-132">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-23-133">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-23-134">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span><span id="__span-23-135">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-23-136">            <span class="p">)</span>
</span><span id="__span-23-137">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-23-138">
</span><span id="__span-23-139">
</span><span id="__span-23-140"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-23-141">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">]),</span>
</span><span id="__span-23-142"><span class="p">):</span>
</span><span id="__span-23-143">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-23-144">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-23-145">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-23-146">
</span><span id="__span-23-147">
</span><span id="__span-23-148"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-23-149"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-23-150">    <span class="n">form_data</span><span class="p">:</span> <span class="n">OAuth2PasswordRequestForm</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(),</span>
</span><span id="__span-23-151"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-23-152">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-23-153">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-23-154">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-23-155">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-23-156">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-23-157">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span><span id="__span-23-158">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-23-159">    <span class="p">)</span>
</span><span id="__span-23-160">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-23-161">
</span><span id="__span-23-162">
</span><span id="__span-23-163"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-23-164"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)):</span>
</span><span id="__span-23-165">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-23-166">
</span><span id="__span-23-167">
</span><span id="__span-23-168"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-23-169"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-23-170">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]),</span>
</span><span id="__span-23-171"><span class="p">):</span>
</span><span id="__span-23-172">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-23-173">
</span><span id="__span-23-174">
</span><span id="__span-23-175"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-23-176"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)):</span>
</span><span id="__span-23-177">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
</div>
</div>
</details>
<h2 id="verify-the-username-and-data-shape">Verify the <code>username</code> and data shape<a class="headerlink" data-preview="" href="#verify-the-username-and-data-shape" title="Permanent link">&para;</a></h2>
<p>We verify that we get a <code>username</code>, and extract the scopes.</p>
<p>And then we validate that data with the Pydantic model (catching the <code>ValidationError</code> exception), and if we get an error reading the JWT token or validating the data with Pydantic, we raise the <code>HTTPException</code> we created before.</p>
<p>For that, we update the Pydantic model <code>TokenData</code> with a new property <code>scopes</code>.</p>
<p>By validating the data with Pydantic we can make sure that we have, for example, exactly a <code>list</code> of <code>str</code> with the scopes and a <code>str</code> with the <code>username</code>.</p>
<p>Instead of, for example, a <code>dict</code>, or something else, as it could break the application at some point later, making it a security risk.</p>
<p>We also verify that we have a user with that username, and if not, we raise that same exception we created before.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="13:1"><input checked="checked" id="__tabbed_13_1" name="__tabbed_13" type="radio" /><div class="tabbed-labels"><label for="__tabbed_13_1">Python 3.10+</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span id="__span-24-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-24-2"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>
</span><span id="__span-24-3">
</span><span id="__span-24-4"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-24-5"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-24-6"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-24-7">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-24-8">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-24-9">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span><span id="__span-24-10"><span class="p">)</span>
</span><span id="__span-24-11"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-24-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-24-13"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-24-14">
</span><span id="__span-24-15"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-24-16"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-24-17"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-24-18"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-24-19"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-24-20">
</span><span id="__span-24-21">
</span><span id="__span-24-22"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-24-23">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-24-24">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-24-25">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-24-26">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-24-27">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-24-28">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-24-29">    <span class="p">},</span>
</span><span id="__span-24-30">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-24-31">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-24-32">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-24-33">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-24-34">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-24-35">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-24-36">    <span class="p">},</span>
</span><span id="__span-24-37"><span class="p">}</span>
</span><span id="__span-24-38">
</span><span id="__span-24-39">
</span><span id="__span-24-40"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-24-41">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-24-42">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-24-43">
</span><span id="__span-24-44">
</span><span id="__span-24-45"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-24-46">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-24-47"><span class="hll">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span id="__span-24-48">
</span><span id="__span-24-49">
</span><span id="__span-24-50"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-24-51">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-24-52">    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-24-53">    <span class="n">full_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-24-54">    <span class="n">disabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-24-55">
</span><span id="__span-24-56">
</span><span id="__span-24-57"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-24-58">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-24-59">
</span><span id="__span-24-60">
</span><span id="__span-24-61"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-24-62">
</span><span id="__span-24-63"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-24-64">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-24-65">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span><span id="__span-24-66"><span class="p">)</span>
</span><span id="__span-24-67">
</span><span id="__span-24-68"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-24-69">
</span><span id="__span-24-70">
</span><span id="__span-24-71"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-24-72">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-24-73">
</span><span id="__span-24-74">
</span><span id="__span-24-75"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-24-76">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-24-77">
</span><span id="__span-24-78">
</span><span id="__span-24-79"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-24-80">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-24-81">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-24-82">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-24-83">
</span><span id="__span-24-84">
</span><span id="__span-24-85"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-24-86">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-24-87">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-24-88">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-24-89">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-24-90">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-24-91">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-24-92">
</span><span id="__span-24-93">
</span><span id="__span-24-94"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">timedelta</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-24-95">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-24-96">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-24-97">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-24-98">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-24-99">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-24-100">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-24-101">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-24-102">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-24-103">
</span><span id="__span-24-104">
</span><span id="__span-24-105"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-24-106">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)]</span>
</span><span id="__span-24-107"><span class="p">):</span>
</span><span id="__span-24-108">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-24-109">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="__span-24-110">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-24-111">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span><span id="__span-24-112">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-24-113">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-24-114">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span><span id="__span-24-115">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-24-116">    <span class="p">)</span>
</span><span id="__span-24-117"><span class="hll">    <span class="k">try</span><span class="p">:</span>
</span></span><span id="__span-24-118"><span class="hll">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span></span><span id="__span-24-119"><span class="hll">        <span class="n">username</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span></span><span id="__span-24-120"><span class="hll">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span id="__span-24-121"><span class="hll">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span></span><span id="__span-24-122"><span class="hll">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span></span><span id="__span-24-123"><span class="hll">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span></span><span id="__span-24-124"><span class="hll">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span></span><span id="__span-24-125"><span class="hll">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span></span><span id="__span-24-126"><span class="hll">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span></span><span id="__span-24-127"><span class="hll">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span></span><span id="__span-24-128"><span class="hll">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span id="__span-24-129"><span class="hll">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span></span><span id="__span-24-130">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-24-131">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-24-132">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-24-133">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-24-134">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span><span id="__span-24-135">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-24-136">            <span class="p">)</span>
</span><span id="__span-24-137">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-24-138">
</span><span id="__span-24-139">
</span><span id="__span-24-140"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-24-141">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">])],</span>
</span><span id="__span-24-142"><span class="p">):</span>
</span><span id="__span-24-143">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-24-144">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-24-145">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-24-146">
</span><span id="__span-24-147">
</span><span id="__span-24-148"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-24-149"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-24-150">    <span class="n">form_data</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span> <span class="n">Depends</span><span class="p">()],</span>
</span><span id="__span-24-151"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-24-152">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-24-153">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-24-154">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-24-155">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-24-156">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-24-157">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span><span id="__span-24-158">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-24-159">    <span class="p">)</span>
</span><span id="__span-24-160">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-24-161">
</span><span id="__span-24-162">
</span><span id="__span-24-163"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-24-164"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span>
</span><span id="__span-24-165">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)],</span>
</span><span id="__span-24-166"><span class="p">):</span>
</span><span id="__span-24-167">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-24-168">
</span><span id="__span-24-169">
</span><span id="__span-24-170"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-24-171"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-24-172">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">])],</span>
</span><span id="__span-24-173"><span class="p">):</span>
</span><span id="__span-24-174">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-24-175">
</span><span id="__span-24-176">
</span><span id="__span-24-177"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-24-178"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)]):</span>
</span><span id="__span-24-179">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
</div>
</div>
<details>
<summary>ü§ì Other versions and variants</summary>
<div class="tabbed-set tabbed-alternate" data-tabs="14:3"><input checked="checked" id="__tabbed_14_1" name="__tabbed_14" type="radio" /><input id="__tabbed_14_2" name="__tabbed_14" type="radio" /><input id="__tabbed_14_3" name="__tabbed_14" type="radio" /><div class="tabbed-labels"><label for="__tabbed_14_1">Python 3.9+</label><label for="__tabbed_14_2">Python 3.10+ - non-Annotated</label><label for="__tabbed_14_3">Python 3.9+ - non-Annotated</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span id="__span-25-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-25-2"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span><span class="p">,</span> <span class="n">Union</span>
</span><span id="__span-25-3">
</span><span id="__span-25-4"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-25-5"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-25-6"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-25-7">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-25-8">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-25-9">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span><span id="__span-25-10"><span class="p">)</span>
</span><span id="__span-25-11"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-25-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-25-13"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-25-14">
</span><span id="__span-25-15"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-25-16"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-25-17"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-25-18"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-25-19"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-25-20">
</span><span id="__span-25-21">
</span><span id="__span-25-22"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-25-23">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-25-24">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-25-25">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-25-26">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-25-27">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-25-28">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-25-29">    <span class="p">},</span>
</span><span id="__span-25-30">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-25-31">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-25-32">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-25-33">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-25-34">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-25-35">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-25-36">    <span class="p">},</span>
</span><span id="__span-25-37"><span class="p">}</span>
</span><span id="__span-25-38">
</span><span id="__span-25-39">
</span><span id="__span-25-40"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-25-41">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-25-42">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-25-43">
</span><span id="__span-25-44">
</span><span id="__span-25-45"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-25-46">    <span class="n">username</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-25-47">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-25-48">
</span><span id="__span-25-49">
</span><span id="__span-25-50"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-25-51">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-25-52">    <span class="n">email</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-25-53">    <span class="n">full_name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-25-54">    <span class="n">disabled</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-25-55">
</span><span id="__span-25-56">
</span><span id="__span-25-57"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-25-58">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-25-59">
</span><span id="__span-25-60">
</span><span id="__span-25-61"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-25-62">
</span><span id="__span-25-63"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-25-64">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-25-65">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span><span id="__span-25-66"><span class="p">)</span>
</span><span id="__span-25-67">
</span><span id="__span-25-68"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-25-69">
</span><span id="__span-25-70">
</span><span id="__span-25-71"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-25-72">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-25-73">
</span><span id="__span-25-74">
</span><span id="__span-25-75"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-25-76">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-25-77">
</span><span id="__span-25-78">
</span><span id="__span-25-79"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-25-80">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-25-81">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-25-82">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-25-83">
</span><span id="__span-25-84">
</span><span id="__span-25-85"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-25-86">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-25-87">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-25-88">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-25-89">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-25-90">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-25-91">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-25-92">
</span><span id="__span-25-93">
</span><span id="__span-25-94"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">timedelta</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-25-95">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-25-96">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-25-97">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-25-98">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-25-99">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-25-100">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-25-101">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-25-102">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-25-103">
</span><span id="__span-25-104">
</span><span id="__span-25-105"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-25-106">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)]</span>
</span><span id="__span-25-107"><span class="p">):</span>
</span><span id="__span-25-108">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-25-109">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="__span-25-110">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-25-111">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span><span id="__span-25-112">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-25-113">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-25-114">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span><span id="__span-25-115">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-25-116">    <span class="p">)</span>
</span><span id="__span-25-117">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-25-118">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-25-119">        <span class="n">username</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-25-120">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-25-121">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-25-122">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-25-123">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-25-124">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-25-125">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span><span id="__span-25-126">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-25-127">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-25-128">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-25-129">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-25-130">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-25-131">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-25-132">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-25-133">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-25-134">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span><span id="__span-25-135">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-25-136">            <span class="p">)</span>
</span><span id="__span-25-137">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-25-138">
</span><span id="__span-25-139">
</span><span id="__span-25-140"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-25-141">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">])],</span>
</span><span id="__span-25-142"><span class="p">):</span>
</span><span id="__span-25-143">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-25-144">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-25-145">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-25-146">
</span><span id="__span-25-147">
</span><span id="__span-25-148"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-25-149"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-25-150">    <span class="n">form_data</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span> <span class="n">Depends</span><span class="p">()],</span>
</span><span id="__span-25-151"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-25-152">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-25-153">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-25-154">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-25-155">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-25-156">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-25-157">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span><span id="__span-25-158">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-25-159">    <span class="p">)</span>
</span><span id="__span-25-160">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-25-161">
</span><span id="__span-25-162">
</span><span id="__span-25-163"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-25-164"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span>
</span><span id="__span-25-165">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)],</span>
</span><span id="__span-25-166"><span class="p">):</span>
</span><span id="__span-25-167">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-25-168">
</span><span id="__span-25-169">
</span><span id="__span-25-170"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-25-171"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-25-172">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">])],</span>
</span><span id="__span-25-173"><span class="p">):</span>
</span><span id="__span-25-174">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-25-175">
</span><span id="__span-25-176">
</span><span id="__span-25-177"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-25-178"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)]):</span>
</span><span id="__span-25-179">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Prefer to use the <code>Annotated</code> version if possible.</p>
</div>
<div class="highlight"><pre><span></span><code><span id="__span-26-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-26-2">
</span><span id="__span-26-3"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-26-4"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-26-5"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-26-6">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-26-7">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-26-8">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span><span id="__span-26-9"><span class="p">)</span>
</span><span id="__span-26-10"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-26-11"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-26-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-26-13">
</span><span id="__span-26-14"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-26-15"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-26-16"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-26-17"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-26-18"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-26-19">
</span><span id="__span-26-20">
</span><span id="__span-26-21"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-26-22">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-26-23">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-26-24">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-26-25">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-26-26">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-26-27">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-26-28">    <span class="p">},</span>
</span><span id="__span-26-29">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-26-30">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-26-31">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-26-32">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-26-33">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-26-34">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-26-35">    <span class="p">},</span>
</span><span id="__span-26-36"><span class="p">}</span>
</span><span id="__span-26-37">
</span><span id="__span-26-38">
</span><span id="__span-26-39"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-26-40">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-26-41">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-26-42">
</span><span id="__span-26-43">
</span><span id="__span-26-44"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-26-45">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-26-46">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-26-47">
</span><span id="__span-26-48">
</span><span id="__span-26-49"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-26-50">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-26-51">    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-26-52">    <span class="n">full_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-26-53">    <span class="n">disabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-26-54">
</span><span id="__span-26-55">
</span><span id="__span-26-56"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-26-57">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-26-58">
</span><span id="__span-26-59">
</span><span id="__span-26-60"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-26-61">
</span><span id="__span-26-62"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-26-63">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-26-64">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span><span id="__span-26-65"><span class="p">)</span>
</span><span id="__span-26-66">
</span><span id="__span-26-67"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-26-68">
</span><span id="__span-26-69">
</span><span id="__span-26-70"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-26-71">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-26-72">
</span><span id="__span-26-73">
</span><span id="__span-26-74"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-26-75">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-26-76">
</span><span id="__span-26-77">
</span><span id="__span-26-78"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-26-79">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-26-80">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-26-81">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-26-82">
</span><span id="__span-26-83">
</span><span id="__span-26-84"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-26-85">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-26-86">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-26-87">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-26-88">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-26-89">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-26-90">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-26-91">
</span><span id="__span-26-92">
</span><span id="__span-26-93"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">timedelta</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-26-94">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-26-95">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-26-96">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-26-97">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-26-98">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-26-99">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-26-100">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-26-101">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-26-102">
</span><span id="__span-26-103">
</span><span id="__span-26-104"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-26-105">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)</span>
</span><span id="__span-26-106"><span class="p">):</span>
</span><span id="__span-26-107">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-26-108">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="__span-26-109">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-26-110">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span><span id="__span-26-111">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-26-112">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-26-113">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span><span id="__span-26-114">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-26-115">    <span class="p">)</span>
</span><span id="__span-26-116">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-26-117">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-26-118">        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-26-119">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-26-120">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-26-121">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-26-122">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-26-123">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-26-124">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span><span id="__span-26-125">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-26-126">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-26-127">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-26-128">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-26-129">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-26-130">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-26-131">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-26-132">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-26-133">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span><span id="__span-26-134">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-26-135">            <span class="p">)</span>
</span><span id="__span-26-136">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-26-137">
</span><span id="__span-26-138">
</span><span id="__span-26-139"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-26-140">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">]),</span>
</span><span id="__span-26-141"><span class="p">):</span>
</span><span id="__span-26-142">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-26-143">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-26-144">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-26-145">
</span><span id="__span-26-146">
</span><span id="__span-26-147"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-26-148"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-26-149">    <span class="n">form_data</span><span class="p">:</span> <span class="n">OAuth2PasswordRequestForm</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(),</span>
</span><span id="__span-26-150"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-26-151">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-26-152">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-26-153">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-26-154">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-26-155">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-26-156">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span><span id="__span-26-157">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-26-158">    <span class="p">)</span>
</span><span id="__span-26-159">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-26-160">
</span><span id="__span-26-161">
</span><span id="__span-26-162"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-26-163"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)):</span>
</span><span id="__span-26-164">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-26-165">
</span><span id="__span-26-166">
</span><span id="__span-26-167"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-26-168"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-26-169">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]),</span>
</span><span id="__span-26-170"><span class="p">):</span>
</span><span id="__span-26-171">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-26-172">
</span><span id="__span-26-173">
</span><span id="__span-26-174"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-26-175"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)):</span>
</span><span id="__span-26-176">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Prefer to use the <code>Annotated</code> version if possible.</p>
</div>
<div class="highlight"><pre><span></span><code><span id="__span-27-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-27-2"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span>
</span><span id="__span-27-3">
</span><span id="__span-27-4"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-27-5"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-27-6"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-27-7">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-27-8">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-27-9">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span><span id="__span-27-10"><span class="p">)</span>
</span><span id="__span-27-11"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-27-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-27-13"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-27-14">
</span><span id="__span-27-15"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-27-16"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-27-17"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-27-18"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-27-19"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-27-20">
</span><span id="__span-27-21">
</span><span id="__span-27-22"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-27-23">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-27-24">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-27-25">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-27-26">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-27-27">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-27-28">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-27-29">    <span class="p">},</span>
</span><span id="__span-27-30">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-27-31">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-27-32">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-27-33">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-27-34">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-27-35">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-27-36">    <span class="p">},</span>
</span><span id="__span-27-37"><span class="p">}</span>
</span><span id="__span-27-38">
</span><span id="__span-27-39">
</span><span id="__span-27-40"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-27-41">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-27-42">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-27-43">
</span><span id="__span-27-44">
</span><span id="__span-27-45"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-27-46">    <span class="n">username</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-27-47">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-27-48">
</span><span id="__span-27-49">
</span><span id="__span-27-50"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-27-51">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-27-52">    <span class="n">email</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-27-53">    <span class="n">full_name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-27-54">    <span class="n">disabled</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-27-55">
</span><span id="__span-27-56">
</span><span id="__span-27-57"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-27-58">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-27-59">
</span><span id="__span-27-60">
</span><span id="__span-27-61"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-27-62">
</span><span id="__span-27-63"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-27-64">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-27-65">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span><span id="__span-27-66"><span class="p">)</span>
</span><span id="__span-27-67">
</span><span id="__span-27-68"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-27-69">
</span><span id="__span-27-70">
</span><span id="__span-27-71"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-27-72">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-27-73">
</span><span id="__span-27-74">
</span><span id="__span-27-75"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-27-76">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-27-77">
</span><span id="__span-27-78">
</span><span id="__span-27-79"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-27-80">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-27-81">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-27-82">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-27-83">
</span><span id="__span-27-84">
</span><span id="__span-27-85"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-27-86">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-27-87">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-27-88">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-27-89">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-27-90">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-27-91">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-27-92">
</span><span id="__span-27-93">
</span><span id="__span-27-94"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">timedelta</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-27-95">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-27-96">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-27-97">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-27-98">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-27-99">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-27-100">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-27-101">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-27-102">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-27-103">
</span><span id="__span-27-104">
</span><span id="__span-27-105"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-27-106">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)</span>
</span><span id="__span-27-107"><span class="p">):</span>
</span><span id="__span-27-108">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-27-109">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="__span-27-110">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-27-111">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span><span id="__span-27-112">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-27-113">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-27-114">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span><span id="__span-27-115">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-27-116">    <span class="p">)</span>
</span><span id="__span-27-117">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-27-118">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-27-119">        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-27-120">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-27-121">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-27-122">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-27-123">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-27-124">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-27-125">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span><span id="__span-27-126">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-27-127">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-27-128">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-27-129">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-27-130">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-27-131">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-27-132">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-27-133">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-27-134">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span><span id="__span-27-135">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-27-136">            <span class="p">)</span>
</span><span id="__span-27-137">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-27-138">
</span><span id="__span-27-139">
</span><span id="__span-27-140"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-27-141">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">]),</span>
</span><span id="__span-27-142"><span class="p">):</span>
</span><span id="__span-27-143">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-27-144">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-27-145">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-27-146">
</span><span id="__span-27-147">
</span><span id="__span-27-148"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-27-149"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-27-150">    <span class="n">form_data</span><span class="p">:</span> <span class="n">OAuth2PasswordRequestForm</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(),</span>
</span><span id="__span-27-151"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-27-152">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-27-153">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-27-154">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-27-155">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-27-156">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-27-157">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span><span id="__span-27-158">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-27-159">    <span class="p">)</span>
</span><span id="__span-27-160">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-27-161">
</span><span id="__span-27-162">
</span><span id="__span-27-163"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-27-164"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)):</span>
</span><span id="__span-27-165">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-27-166">
</span><span id="__span-27-167">
</span><span id="__span-27-168"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-27-169"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-27-170">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]),</span>
</span><span id="__span-27-171"><span class="p">):</span>
</span><span id="__span-27-172">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-27-173">
</span><span id="__span-27-174">
</span><span id="__span-27-175"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-27-176"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)):</span>
</span><span id="__span-27-177">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
</div>
</div>
</details>
<h2 id="verify-the-scopes">Verify the <code>scopes</code><a class="headerlink" data-preview="" href="#verify-the-scopes" title="Permanent link">&para;</a></h2>
<p>We now verify that all the scopes required, by this dependency and all the dependants (including <em>path operations</em>), are included in the scopes provided in the token received, otherwise raise an <code>HTTPException</code>.</p>
<p>For this, we use <code>security_scopes.scopes</code>, that contains a <code>list</code> with all these scopes as <code>str</code>.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="15:1"><input checked="checked" id="__tabbed_15_1" name="__tabbed_15" type="radio" /><div class="tabbed-labels"><label for="__tabbed_15_1">Python 3.10+</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span id="__span-28-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-28-2"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>
</span><span id="__span-28-3">
</span><span id="__span-28-4"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-28-5"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-28-6"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-28-7">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-28-8">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-28-9">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span><span id="__span-28-10"><span class="p">)</span>
</span><span id="__span-28-11"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-28-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-28-13"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-28-14">
</span><span id="__span-28-15"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-28-16"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-28-17"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-28-18"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-28-19"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-28-20">
</span><span id="__span-28-21">
</span><span id="__span-28-22"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-28-23">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-28-24">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-28-25">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-28-26">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-28-27">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-28-28">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-28-29">    <span class="p">},</span>
</span><span id="__span-28-30">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-28-31">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-28-32">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-28-33">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-28-34">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-28-35">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-28-36">    <span class="p">},</span>
</span><span id="__span-28-37"><span class="p">}</span>
</span><span id="__span-28-38">
</span><span id="__span-28-39">
</span><span id="__span-28-40"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-28-41">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-28-42">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-28-43">
</span><span id="__span-28-44">
</span><span id="__span-28-45"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-28-46">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-28-47">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-28-48">
</span><span id="__span-28-49">
</span><span id="__span-28-50"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-28-51">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-28-52">    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-28-53">    <span class="n">full_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-28-54">    <span class="n">disabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-28-55">
</span><span id="__span-28-56">
</span><span id="__span-28-57"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-28-58">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-28-59">
</span><span id="__span-28-60">
</span><span id="__span-28-61"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-28-62">
</span><span id="__span-28-63"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-28-64">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-28-65">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span><span id="__span-28-66"><span class="p">)</span>
</span><span id="__span-28-67">
</span><span id="__span-28-68"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-28-69">
</span><span id="__span-28-70">
</span><span id="__span-28-71"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-28-72">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-28-73">
</span><span id="__span-28-74">
</span><span id="__span-28-75"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-28-76">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-28-77">
</span><span id="__span-28-78">
</span><span id="__span-28-79"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-28-80">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-28-81">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-28-82">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-28-83">
</span><span id="__span-28-84">
</span><span id="__span-28-85"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-28-86">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-28-87">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-28-88">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-28-89">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-28-90">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-28-91">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-28-92">
</span><span id="__span-28-93">
</span><span id="__span-28-94"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">timedelta</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-28-95">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-28-96">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-28-97">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-28-98">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-28-99">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-28-100">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-28-101">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-28-102">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-28-103">
</span><span id="__span-28-104">
</span><span id="__span-28-105"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-28-106">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)]</span>
</span><span id="__span-28-107"><span class="p">):</span>
</span><span id="__span-28-108">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-28-109">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="__span-28-110">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-28-111">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span><span id="__span-28-112">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-28-113">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-28-114">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span><span id="__span-28-115">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-28-116">    <span class="p">)</span>
</span><span id="__span-28-117">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-28-118">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-28-119">        <span class="n">username</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-28-120">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-28-121">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-28-122">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-28-123">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-28-124">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-28-125">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span><span id="__span-28-126">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-28-127">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-28-128">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-28-129">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-28-130"><span class="hll">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span></span><span id="__span-28-131"><span class="hll">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span></span><span id="__span-28-132"><span class="hll">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span></span><span id="__span-28-133"><span class="hll">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span></span><span id="__span-28-134"><span class="hll">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span></span><span id="__span-28-135"><span class="hll">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span></span><span id="__span-28-136"><span class="hll">            <span class="p">)</span>
</span></span><span id="__span-28-137">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-28-138">
</span><span id="__span-28-139">
</span><span id="__span-28-140"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-28-141">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">])],</span>
</span><span id="__span-28-142"><span class="p">):</span>
</span><span id="__span-28-143">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-28-144">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-28-145">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-28-146">
</span><span id="__span-28-147">
</span><span id="__span-28-148"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-28-149"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-28-150">    <span class="n">form_data</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span> <span class="n">Depends</span><span class="p">()],</span>
</span><span id="__span-28-151"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-28-152">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-28-153">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-28-154">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-28-155">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-28-156">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-28-157">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span><span id="__span-28-158">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-28-159">    <span class="p">)</span>
</span><span id="__span-28-160">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-28-161">
</span><span id="__span-28-162">
</span><span id="__span-28-163"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-28-164"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span>
</span><span id="__span-28-165">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)],</span>
</span><span id="__span-28-166"><span class="p">):</span>
</span><span id="__span-28-167">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-28-168">
</span><span id="__span-28-169">
</span><span id="__span-28-170"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-28-171"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-28-172">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">])],</span>
</span><span id="__span-28-173"><span class="p">):</span>
</span><span id="__span-28-174">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-28-175">
</span><span id="__span-28-176">
</span><span id="__span-28-177"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-28-178"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)]):</span>
</span><span id="__span-28-179">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
</div>
</div>
<details>
<summary>ü§ì Other versions and variants</summary>
<div class="tabbed-set tabbed-alternate" data-tabs="16:3"><input checked="checked" id="__tabbed_16_1" name="__tabbed_16" type="radio" /><input id="__tabbed_16_2" name="__tabbed_16" type="radio" /><input id="__tabbed_16_3" name="__tabbed_16" type="radio" /><div class="tabbed-labels"><label for="__tabbed_16_1">Python 3.9+</label><label for="__tabbed_16_2">Python 3.10+ - non-Annotated</label><label for="__tabbed_16_3">Python 3.9+ - non-Annotated</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span id="__span-29-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-29-2"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span><span class="p">,</span> <span class="n">Union</span>
</span><span id="__span-29-3">
</span><span id="__span-29-4"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-29-5"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-29-6"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-29-7">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-29-8">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-29-9">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span><span id="__span-29-10"><span class="p">)</span>
</span><span id="__span-29-11"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-29-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-29-13"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-29-14">
</span><span id="__span-29-15"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-29-16"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-29-17"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-29-18"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-29-19"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-29-20">
</span><span id="__span-29-21">
</span><span id="__span-29-22"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-29-23">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-29-24">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-29-25">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-29-26">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-29-27">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-29-28">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-29-29">    <span class="p">},</span>
</span><span id="__span-29-30">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-29-31">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-29-32">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-29-33">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-29-34">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-29-35">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-29-36">    <span class="p">},</span>
</span><span id="__span-29-37"><span class="p">}</span>
</span><span id="__span-29-38">
</span><span id="__span-29-39">
</span><span id="__span-29-40"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-29-41">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-29-42">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-29-43">
</span><span id="__span-29-44">
</span><span id="__span-29-45"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-29-46">    <span class="n">username</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-29-47">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-29-48">
</span><span id="__span-29-49">
</span><span id="__span-29-50"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-29-51">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-29-52">    <span class="n">email</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-29-53">    <span class="n">full_name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-29-54">    <span class="n">disabled</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-29-55">
</span><span id="__span-29-56">
</span><span id="__span-29-57"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-29-58">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-29-59">
</span><span id="__span-29-60">
</span><span id="__span-29-61"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-29-62">
</span><span id="__span-29-63"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-29-64">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-29-65">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span><span id="__span-29-66"><span class="p">)</span>
</span><span id="__span-29-67">
</span><span id="__span-29-68"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-29-69">
</span><span id="__span-29-70">
</span><span id="__span-29-71"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-29-72">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-29-73">
</span><span id="__span-29-74">
</span><span id="__span-29-75"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-29-76">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-29-77">
</span><span id="__span-29-78">
</span><span id="__span-29-79"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-29-80">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-29-81">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-29-82">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-29-83">
</span><span id="__span-29-84">
</span><span id="__span-29-85"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-29-86">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-29-87">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-29-88">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-29-89">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-29-90">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-29-91">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-29-92">
</span><span id="__span-29-93">
</span><span id="__span-29-94"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">timedelta</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-29-95">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-29-96">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-29-97">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-29-98">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-29-99">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-29-100">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-29-101">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-29-102">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-29-103">
</span><span id="__span-29-104">
</span><span id="__span-29-105"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-29-106">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)]</span>
</span><span id="__span-29-107"><span class="p">):</span>
</span><span id="__span-29-108">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-29-109">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="__span-29-110">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-29-111">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span><span id="__span-29-112">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-29-113">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-29-114">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span><span id="__span-29-115">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-29-116">    <span class="p">)</span>
</span><span id="__span-29-117">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-29-118">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-29-119">        <span class="n">username</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-29-120">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-29-121">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-29-122">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-29-123">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-29-124">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-29-125">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span><span id="__span-29-126">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-29-127">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-29-128">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-29-129">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-29-130">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-29-131">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-29-132">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-29-133">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-29-134">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span><span id="__span-29-135">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-29-136">            <span class="p">)</span>
</span><span id="__span-29-137">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-29-138">
</span><span id="__span-29-139">
</span><span id="__span-29-140"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-29-141">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">])],</span>
</span><span id="__span-29-142"><span class="p">):</span>
</span><span id="__span-29-143">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-29-144">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-29-145">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-29-146">
</span><span id="__span-29-147">
</span><span id="__span-29-148"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-29-149"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-29-150">    <span class="n">form_data</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span> <span class="n">Depends</span><span class="p">()],</span>
</span><span id="__span-29-151"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-29-152">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-29-153">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-29-154">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-29-155">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-29-156">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-29-157">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span><span id="__span-29-158">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-29-159">    <span class="p">)</span>
</span><span id="__span-29-160">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-29-161">
</span><span id="__span-29-162">
</span><span id="__span-29-163"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-29-164"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span>
</span><span id="__span-29-165">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)],</span>
</span><span id="__span-29-166"><span class="p">):</span>
</span><span id="__span-29-167">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-29-168">
</span><span id="__span-29-169">
</span><span id="__span-29-170"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-29-171"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-29-172">    <span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">])],</span>
</span><span id="__span-29-173"><span class="p">):</span>
</span><span id="__span-29-174">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-29-175">
</span><span id="__span-29-176">
</span><span id="__span-29-177"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-29-178"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)]):</span>
</span><span id="__span-29-179">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Prefer to use the <code>Annotated</code> version if possible.</p>
</div>
<div class="highlight"><pre><span></span><code><span id="__span-30-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-30-2">
</span><span id="__span-30-3"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-30-4"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-30-5"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-30-6">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-30-7">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-30-8">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span><span id="__span-30-9"><span class="p">)</span>
</span><span id="__span-30-10"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-30-11"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-30-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-30-13">
</span><span id="__span-30-14"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-30-15"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-30-16"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-30-17"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-30-18"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-30-19">
</span><span id="__span-30-20">
</span><span id="__span-30-21"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-30-22">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-30-23">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-30-24">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-30-25">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-30-26">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-30-27">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-30-28">    <span class="p">},</span>
</span><span id="__span-30-29">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-30-30">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-30-31">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-30-32">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-30-33">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-30-34">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-30-35">    <span class="p">},</span>
</span><span id="__span-30-36"><span class="p">}</span>
</span><span id="__span-30-37">
</span><span id="__span-30-38">
</span><span id="__span-30-39"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-30-40">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-30-41">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-30-42">
</span><span id="__span-30-43">
</span><span id="__span-30-44"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-30-45">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-30-46">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-30-47">
</span><span id="__span-30-48">
</span><span id="__span-30-49"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-30-50">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-30-51">    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-30-52">    <span class="n">full_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-30-53">    <span class="n">disabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-30-54">
</span><span id="__span-30-55">
</span><span id="__span-30-56"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-30-57">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-30-58">
</span><span id="__span-30-59">
</span><span id="__span-30-60"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-30-61">
</span><span id="__span-30-62"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-30-63">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-30-64">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span><span id="__span-30-65"><span class="p">)</span>
</span><span id="__span-30-66">
</span><span id="__span-30-67"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-30-68">
</span><span id="__span-30-69">
</span><span id="__span-30-70"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-30-71">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-30-72">
</span><span id="__span-30-73">
</span><span id="__span-30-74"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-30-75">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-30-76">
</span><span id="__span-30-77">
</span><span id="__span-30-78"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-30-79">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-30-80">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-30-81">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-30-82">
</span><span id="__span-30-83">
</span><span id="__span-30-84"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-30-85">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-30-86">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-30-87">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-30-88">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-30-89">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-30-90">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-30-91">
</span><span id="__span-30-92">
</span><span id="__span-30-93"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">timedelta</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-30-94">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-30-95">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-30-96">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-30-97">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-30-98">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-30-99">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-30-100">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-30-101">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-30-102">
</span><span id="__span-30-103">
</span><span id="__span-30-104"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-30-105">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)</span>
</span><span id="__span-30-106"><span class="p">):</span>
</span><span id="__span-30-107">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-30-108">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="__span-30-109">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-30-110">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span><span id="__span-30-111">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-30-112">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-30-113">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span><span id="__span-30-114">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-30-115">    <span class="p">)</span>
</span><span id="__span-30-116">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-30-117">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-30-118">        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-30-119">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-30-120">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-30-121">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-30-122">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-30-123">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-30-124">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span><span id="__span-30-125">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-30-126">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-30-127">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-30-128">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-30-129">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-30-130">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-30-131">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-30-132">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-30-133">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span><span id="__span-30-134">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-30-135">            <span class="p">)</span>
</span><span id="__span-30-136">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-30-137">
</span><span id="__span-30-138">
</span><span id="__span-30-139"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-30-140">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">]),</span>
</span><span id="__span-30-141"><span class="p">):</span>
</span><span id="__span-30-142">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-30-143">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-30-144">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-30-145">
</span><span id="__span-30-146">
</span><span id="__span-30-147"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-30-148"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-30-149">    <span class="n">form_data</span><span class="p">:</span> <span class="n">OAuth2PasswordRequestForm</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(),</span>
</span><span id="__span-30-150"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-30-151">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-30-152">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-30-153">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-30-154">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-30-155">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-30-156">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span><span id="__span-30-157">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-30-158">    <span class="p">)</span>
</span><span id="__span-30-159">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-30-160">
</span><span id="__span-30-161">
</span><span id="__span-30-162"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-30-163"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)):</span>
</span><span id="__span-30-164">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-30-165">
</span><span id="__span-30-166">
</span><span id="__span-30-167"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-30-168"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-30-169">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]),</span>
</span><span id="__span-30-170"><span class="p">):</span>
</span><span id="__span-30-171">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-30-172">
</span><span id="__span-30-173">
</span><span id="__span-30-174"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-30-175"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)):</span>
</span><span id="__span-30-176">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Prefer to use the <code>Annotated</code> version if possible.</p>
</div>
<div class="highlight"><pre><span></span><code><span id="__span-31-1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-31-2"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span>
</span><span id="__span-31-3">
</span><span id="__span-31-4"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-31-5"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Security</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-31-6"><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-31-7">    <span class="n">OAuth2PasswordBearer</span><span class="p">,</span>
</span><span id="__span-31-8">    <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span>
</span><span id="__span-31-9">    <span class="n">SecurityScopes</span><span class="p">,</span>
</span><span id="__span-31-10"><span class="p">)</span>
</span><span id="__span-31-11"><span class="kn">from</span><span class="w"> </span><span class="nn">jwt.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidTokenError</span>
</span><span id="__span-31-12"><span class="kn">from</span><span class="w"> </span><span class="nn">pwdlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">PasswordHash</span>
</span><span id="__span-31-13"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
</span><span id="__span-31-14">
</span><span id="__span-31-15"><span class="c1"># to get a string like this run:</span>
</span><span id="__span-31-16"><span class="c1"># openssl rand -hex 32</span>
</span><span id="__span-31-17"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>
</span><span id="__span-31-18"><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
</span><span id="__span-31-19"><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-31-20">
</span><span id="__span-31-21">
</span><span id="__span-31-22"><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-31-23">    <span class="s2">&quot;johndoe&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-31-24">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
</span><span id="__span-31-25">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-31-26">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-31-27">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$wagCPXjifgvUFBzq4hqe3w$CYaIb8sB+wtD+Vu/P4uod1+Qof8h+1g7bbDlBID48Rc&quot;</span><span class="p">,</span>
</span><span id="__span-31-28">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-31-29">    <span class="p">},</span>
</span><span id="__span-31-30">    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-31-31">        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
</span><span id="__span-31-32">        <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Chains&quot;</span><span class="p">,</span>
</span><span id="__span-31-33">        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alicechains@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-31-34">        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$argon2id$v=19$m=65536,t=3,p=4$g2/AV1zwopqUntPKJavBFw$BwpRGDCyUHLvHICnwijyX8ROGoiUPwNKZ7915MeYfCE&quot;</span><span class="p">,</span>
</span><span id="__span-31-35">        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-31-36">    <span class="p">},</span>
</span><span id="__span-31-37"><span class="p">}</span>
</span><span id="__span-31-38">
</span><span id="__span-31-39">
</span><span id="__span-31-40"><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-31-41">    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-31-42">    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-31-43">
</span><span id="__span-31-44">
</span><span id="__span-31-45"><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-31-46">    <span class="n">username</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-31-47">    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-31-48">
</span><span id="__span-31-49">
</span><span id="__span-31-50"><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-31-51">    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-31-52">    <span class="n">email</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-31-53">    <span class="n">full_name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-31-54">    <span class="n">disabled</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-31-55">
</span><span id="__span-31-56">
</span><span id="__span-31-57"><span class="k">class</span><span class="w"> </span><span class="nc">UserInDB</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
</span><span id="__span-31-58">    <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-31-59">
</span><span id="__span-31-60">
</span><span id="__span-31-61"><span class="n">password_hash</span> <span class="o">=</span> <span class="n">PasswordHash</span><span class="o">.</span><span class="n">recommended</span><span class="p">()</span>
</span><span id="__span-31-62">
</span><span id="__span-31-63"><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
</span><span id="__span-31-64">    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span id="__span-31-65">    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="s2">&quot;Read information about the current user.&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="s2">&quot;Read items.&quot;</span><span class="p">},</span>
</span><span id="__span-31-66"><span class="p">)</span>
</span><span id="__span-31-67">
</span><span id="__span-31-68"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-31-69">
</span><span id="__span-31-70">
</span><span id="__span-31-71"><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-31-72">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span id="__span-31-73">
</span><span id="__span-31-74">
</span><span id="__span-31-75"><span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span id="__span-31-76">    <span class="k">return</span> <span class="n">password_hash</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-31-77">
</span><span id="__span-31-78">
</span><span id="__span-31-79"><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-31-80">    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-31-81">        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
</span><span id="__span-31-82">        <span class="k">return</span> <span class="n">UserInDB</span><span class="p">(</span><span class="o">**</span><span class="n">user_dict</span><span class="p">)</span>
</span><span id="__span-31-83">
</span><span id="__span-31-84">
</span><span id="__span-31-85"><span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-31-86">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span id="__span-31-87">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-31-88">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-31-89">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">):</span>
</span><span id="__span-31-90">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-31-91">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-31-92">
</span><span id="__span-31-93">
</span><span id="__span-31-94"><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">timedelta</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-31-95">    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-31-96">    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
</span><span id="__span-31-97">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
</span><span id="__span-31-98">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-31-99">        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-31-100">    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
</span><span id="__span-31-101">    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
</span><span id="__span-31-102">    <span class="k">return</span> <span class="n">encoded_jwt</span>
</span><span id="__span-31-103">
</span><span id="__span-31-104">
</span><span id="__span-31-105"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
</span><span id="__span-31-106">    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">)</span>
</span><span id="__span-31-107"><span class="p">):</span>
</span><span id="__span-31-108">    <span class="k">if</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-31-109">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="__span-31-110">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-31-111">        <span class="n">authenticate_value</span> <span class="o">=</span> <span class="s2">&quot;Bearer&quot;</span>
</span><span id="__span-31-112">    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-31-113">        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-31-114">        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Could not validate credentials&quot;</span><span class="p">,</span>
</span><span id="__span-31-115">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-31-116">    <span class="p">)</span>
</span><span id="__span-31-117">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-31-118">        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
</span><span id="__span-31-119">        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</span><span id="__span-31-120">        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-31-121">            <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-31-122">        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-31-123">        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-31-124">        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-31-125">    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span><span id="__span-31-126">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-31-127">    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="__span-31-128">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-31-129">        <span class="k">raise</span> <span class="n">credentials_exception</span>
</span><span id="__span-31-130">    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-31-131">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
</span><span id="__span-31-132">            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-31-133">                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
</span><span id="__span-31-134">                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not enough permissions&quot;</span><span class="p">,</span>
</span><span id="__span-31-135">                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="n">authenticate_value</span><span class="p">},</span>
</span><span id="__span-31-136">            <span class="p">)</span>
</span><span id="__span-31-137">    <span class="k">return</span> <span class="n">user</span>
</span><span id="__span-31-138">
</span><span id="__span-31-139">
</span><span id="__span-31-140"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
</span><span id="__span-31-141">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;me&quot;</span><span class="p">]),</span>
</span><span id="__span-31-142"><span class="p">):</span>
</span><span id="__span-31-143">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">disabled</span><span class="p">:</span>
</span><span id="__span-31-144">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive user&quot;</span><span class="p">)</span>
</span><span id="__span-31-145">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-31-146">
</span><span id="__span-31-147">
</span><span id="__span-31-148"><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
</span><span id="__span-31-149"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_for_access_token</span><span class="p">(</span>
</span><span id="__span-31-150">    <span class="n">form_data</span><span class="p">:</span> <span class="n">OAuth2PasswordRequestForm</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(),</span>
</span><span id="__span-31-151"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span><span class="p">:</span>
</span><span id="__span-31-152">    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">fake_users_db</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-31-153">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-31-154">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Incorrect username or password&quot;</span><span class="p">)</span>
</span><span id="__span-31-155">    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
</span><span id="__span-31-156">    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
</span><span id="__span-31-157">        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">)},</span>
</span><span id="__span-31-158">        <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span><span class="p">,</span>
</span><span id="__span-31-159">    <span class="p">)</span>
</span><span id="__span-31-160">    <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span><span class="p">)</span>
</span><span id="__span-31-161">
</span><span id="__span-31-162">
</span><span id="__span-31-163"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
</span><span id="__span-31-164"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users_me</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)):</span>
</span><span id="__span-31-165">    <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-31-166">
</span><span id="__span-31-167">
</span><span id="__span-31-168"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me/items/&quot;</span><span class="p">)</span>
</span><span id="__span-31-169"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_own_items</span><span class="p">(</span>
</span><span id="__span-31-170">    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]),</span>
</span><span id="__span-31-171"><span class="p">):</span>
</span><span id="__span-31-172">    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">}]</span>
</span><span id="__span-31-173">
</span><span id="__span-31-174">
</span><span id="__span-31-175"><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/status/&quot;</span><span class="p">)</span>
</span><span id="__span-31-176"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_system_status</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)):</span>
</span><span id="__span-31-177">    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</span></code></pre></div>
</div>
</div>
</div>
</details>
<h2 id="dependency-tree-and-scopes">Dependency tree and scopes<a class="headerlink" data-preview="" href="#dependency-tree-and-scopes" title="Permanent link">&para;</a></h2>
<p>Let's review again this dependency tree and the scopes.</p>
<p>As the <code>get_current_active_user</code> dependency has as a sub-dependency on <code>get_current_user</code>, the scope <code>"me"</code> declared at <code>get_current_active_user</code> will be included in the list of required scopes in the <code>security_scopes.scopes</code> passed to <code>get_current_user</code>.</p>
<p>The <em>path operation</em> itself also declares a scope, <code>"items"</code>, so this will also be in the list of <code>security_scopes.scopes</code> passed to <code>get_current_user</code>.</p>
<p>Here's how the hierarchy of dependencies and scopes looks like:</p>
<ul>
<li>The <em>path operation</em> <code>read_own_items</code> has:<ul>
<li>Required scopes <code>["items"]</code> with the dependency:</li>
<li><code>get_current_active_user</code>:<ul>
<li>The dependency function <code>get_current_active_user</code> has:<ul>
<li>Required scopes <code>["me"]</code> with the dependency:</li>
<li><code>get_current_user</code>:<ul>
<li>The dependency function <code>get_current_user</code> has:<ul>
<li>No scopes required by itself.</li>
<li>A dependency using <code>oauth2_scheme</code>.</li>
<li>A <code>security_scopes</code> parameter of type <code>SecurityScopes</code>:<ul>
<li>This <code>security_scopes</code> parameter has a property <code>scopes</code> with a <code>list</code> containing all these scopes declared above, so:<ul>
<li><code>security_scopes.scopes</code> will contain <code>["me", "items"]</code> for the <em>path operation</em> <code>read_own_items</code>.</li>
<li><code>security_scopes.scopes</code> will contain <code>["me"]</code> for the <em>path operation</em> <code>read_users_me</code>, because it is declared in the dependency <code>get_current_active_user</code>.</li>
<li><code>security_scopes.scopes</code> will contain <code>[]</code> (nothing) for the <em>path operation</em> <code>read_system_status</code>, because it didn't declare any <code>Security</code> with <code>scopes</code>, and its dependency, <code>get_current_user</code>, doesn't declare any <code>scopes</code> either.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The important and "magic" thing here is that <code>get_current_user</code> will have a different list of <code>scopes</code> to check for each <em>path operation</em>.</p>
<p>All depending on the <code>scopes</code> declared in each <em>path operation</em> and each dependency in the dependency tree for that specific <em>path operation</em>.</p>
</div>
<h2 id="more-details-about-securityscopes">More details about <code>SecurityScopes</code><a class="headerlink" data-preview="" href="#more-details-about-securityscopes" title="Permanent link">&para;</a></h2>
<p>You can use <code>SecurityScopes</code> at any point, and in multiple places, it doesn't have to be at the "root" dependency.</p>
<p>It will always have the security scopes declared in the current <code>Security</code> dependencies and all the dependants for <strong>that specific</strong> <em>path operation</em> and <strong>that specific</strong> dependency tree.</p>
<p>Because the <code>SecurityScopes</code> will have all the scopes declared by dependants, you can use it to verify that a token has the required scopes in a central dependency function, and then declare different scope requirements in different <em>path operations</em>.</p>
<p>They will be checked independently for each <em>path operation</em>.</p>
<h2 id="check-it">Check it<a class="headerlink" data-preview="" href="#check-it" title="Permanent link">&para;</a></h2>
<p>If you open the API docs, you can authenticate and specify which scopes you want to authorize.</p>
<p><img src="/img/tutorial/security/image11.png"></p>
<p>If you don't select any scope, you will be "authenticated", but when you try to access <code>/users/me/</code> or <code>/users/me/items/</code> you will get an error saying that you don't have enough permissions. You will still be able to access <code>/status/</code>.</p>
<p>And if you select the scope <code>me</code> but not the scope <code>items</code>, you will be able to access <code>/users/me/</code> but not <code>/users/me/items/</code>.</p>
<p>That's what would happen to a third party application that tried to access one of these <em>path operations</em> with a token provided by a user, depending on how many permissions the user gave the application.</p>
<h2 id="about-third-party-integrations">About third party integrations<a class="headerlink" data-preview="" href="#about-third-party-integrations" title="Permanent link">&para;</a></h2>
<p>In this example we are using the OAuth2 "password" flow.</p>
<p>This is appropriate when we are logging in to our own application, probably with our own frontend.</p>
<p>Because we can trust it to receive the <code>username</code> and <code>password</code>, as we control it.</p>
<p>But if you are building an OAuth2 application that others would connect to (i.e., if you are building an authentication provider equivalent to Facebook, Google, GitHub, etc.) you should use one of the other flows.</p>
<p>The most common is the implicit flow.</p>
<p>The most secure is the code flow, but it's more complex to implement as it requires more steps. As it is more complex, many providers end up suggesting the implicit flow.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It's common that each authentication provider names their flows in a different way, to make it part of their brand.</p>
<p>But in the end, they are implementing the same OAuth2 standard.</p>
</div>
<p><strong>FastAPI</strong> includes utilities for all these OAuth2 authentication flows in <code>fastapi.security.oauth2</code>.</p>
<h2 id="security-in-decorator-dependencies"><code>Security</code> in decorator <code>dependencies</code><a class="headerlink" data-preview="" href="#security-in-decorator-dependencies" title="Permanent link">&para;</a></h2>
<p>The same way you can define a <code>list</code> of <code>Depends</code> in the decorator's <code>dependencies</code> parameter (as explained in <a class="internal-link" data-preview="" href="../../../tutorial/dependencies/dependencies-in-path-operation-decorators/" target="_blank">Dependencies in path operation decorators</a>), you could also use <code>Security</code> with <code>scopes</code> there.</p>







  
  






                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../" class="md-footer__link md-footer__link--prev" aria-label="Previous: Advanced Security">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Advanced Security
              </div>
            </div>
          </a>
        
        
          
          <a href="../http-basic-auth/" class="md-footer__link md-footer__link--next" aria-label="Next: HTTP Basic Auth">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                HTTP Basic Auth
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
    <div class="md-copyright__highlight">
        The FastAPI trademark is owned by <a href="https://tiangolo.com" target="_blank">@tiangolo</a> and is registered in the US and across other regions
    </div>
    
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
        Material for MkDocs
    </a>
    
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/fastapi/fastapi" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M202.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M496 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://discord.gg/VQjSZaeJmf" target="_blank" rel="noopener" title="discord.gg" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M492.5 69.8c-.2-.3-.4-.6-.8-.7-38.1-17.5-78.4-30-119.7-37.1-.4-.1-.8 0-1.1.1s-.6.4-.8.8c-5.5 9.9-10.5 20.2-14.9 30.6-44.6-6.8-89.9-6.8-134.4 0-4.5-10.5-9.5-20.7-15.1-30.6-.2-.3-.5-.6-.8-.8s-.7-.2-1.1-.2C162.5 39 122.2 51.5 84.1 69c-.3.1-.6.4-.8.7C7.1 183.5-13.8 294.6-3.6 404.2c0 .3.1.5.2.8s.3.4.5.6c44.4 32.9 94 58 146.8 74.2.4.1.8.1 1.1 0s.7-.4.9-.7c11.3-15.4 21.4-31.8 30-48.8.1-.2.2-.5.2-.8s0-.5-.1-.8-.2-.5-.4-.6-.4-.3-.7-.4c-15.8-6.1-31.2-13.4-45.9-21.9-.3-.2-.5-.4-.7-.6s-.3-.6-.3-.9 0-.6.2-.9.3-.5.6-.7c3.1-2.3 6.2-4.7 9.1-7.1.3-.2.6-.4.9-.4s.7 0 1 .1c96.2 43.9 200.4 43.9 295.5 0 .3-.1.7-.2 1-.2s.7.2.9.4c2.9 2.4 6 4.9 9.1 7.2.2.2.4.4.6.7s.2.6.2.9-.1.6-.3.9-.4.5-.6.6c-14.7 8.6-30 15.9-45.9 21.8-.2.1-.5.2-.7.4s-.3.4-.4.7-.1.5-.1.8.1.5.2.8c8.8 17 18.8 33.3 30 48.8.2.3.6.6.9.7s.8.1 1.1 0c52.9-16.2 102.6-41.3 147.1-74.2.2-.2.4-.4.5-.6s.2-.5.2-.8c12.3-126.8-20.5-236.9-86.9-334.5zm-302 267.7c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.4 59.2-52.8 59.2m195.4 0c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.2 59.2-52.8 59.2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://x.com/fastapi" target="_blank" rel="noopener" title="x.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M459.4 151.7c.3 4.5.3 9.1.3 13.6 0 138.7-105.6 298.6-298.6 298.6-59.5 0-114.7-17.2-161.1-47.1 8.4 1 16.6 1.3 25.3 1.3 49.1 0 94.2-16.6 130.3-44.8-46.1-1-84.8-31.2-98.1-72.8 6.5 1 13 1.6 19.8 1.6 9.4 0 18.8-1.3 27.6-3.6-48.1-9.7-84.1-52-84.1-103v-1.3c14 7.8 30.2 12.7 47.4 13.3-28.3-18.8-46.8-51-46.8-87.4 0-19.5 5.2-37.4 14.3-53C87.4 130.8 165 172.4 252.1 176.9c-1.6-7.8-2.6-15.9-2.6-24C249.5 95.1 296.3 48 354.4 48c30.2 0 57.5 12.7 76.7 33.1 23.7-4.5 46.5-13.3 66.6-25.3-7.8 24.4-24.4 44.8-46.1 57.8 21.1-2.3 41.6-8.1 60.4-16.2-14.3 20.8-32.2 39.3-52.6 54.3"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/company/fastapi" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://tiangolo.com" target="_blank" rel="noopener" title="tiangolo.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M351.9 280H161c2.9 64.5 17.2 123.9 37.5 167.4 11.4 24.5 23.7 41.8 35.1 52.4 11.2 10.5 18.9 12.2 22.9 12.2s11.7-1.7 22.9-12.2c11.4-10.6 23.7-28 35.1-52.4 20.3-43.5 34.6-102.9 37.5-167.4zm-191-48h190.9c-2.8-64.5-17.1-123.9-37.4-167.4-11.4-24.4-23.7-41.8-35.1-52.4C268.1 1.7 260.4 0 256.4 0s-11.7 1.7-22.9 12.2c-11.4 10.6-23.7 28-35.1 52.4-20.3 43.5-34.6 102.9-37.5 167.4m-48 0c3.5-85.6 25.6-165.1 57.9-217.3C78.7 47.3 10.9 131.2 1.5 232zM1.5 280c9.4 100.8 77.2 184.7 169.3 217.3-32.3-52.2-54.4-131.7-57.9-217.3zm398.4 0c-3.5 85.6-25.6 165.1-57.9 217.3 92.1-32.7 159.9-116.5 169.3-217.3zm111.4-48C501.9 131.2 434.1 47.3 342 14.7c32.3 52.2 54.4 131.7 57.9 217.3z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["content.code.annotate", "content.code.copy", "content.footnote.tooltips", "content.tabs.link", "content.tooltips", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.path", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
        <script src="../../../js/termynal.js"></script>
      
        <script src="../../../js/custom.js"></script>
      
    
  <!-- Cloudflare Pages Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "83c63961621f43319d43d493c35d7611"}'></script><!-- Cloudflare Pages Analytics --></body>
</html>